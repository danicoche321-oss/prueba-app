<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Antigravity Fitness</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Tu entrenador personal de bolsillo con gamificaci√≥n y seguimiento avanzado">
    <meta name="theme-color" content="#E63946">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Antigravity">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs (Compat for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Confetti for PRs -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Chart.js for Progress -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="css/styles.css">

    <!-- Theme Config (Inlined) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        gold: {
                            400: '#FACC15',
                            500: '#EAB308',
                            600: '#CA8A04',
                        },
                        primary: {
                            DEFAULT: '#E63946',
                            50: '#FDECEC',
                            100: '#FBD9DA',
                            200: '#F7B4B6',
                            300: '#F38E92',
                            400: '#EF696E',
                            500: '#E63946',
                            600: '#CF1D2A',
                            700: '#A61722',
                            800: '#7D1119',
                            900: '#530B11'
                        },
                        secondary: '#1D3557',
                        background: '#fafaf9',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'bounce-in': 'bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    // ... keyframes (implicitly kept by merging or we need to restate them if we replaced the parent object? No, this is replacing the whole config script block basically? No, just the colors part?
                    // Wait, I need to be careful. The user provided replacement replaces lines 44-140.
                    // I must include all keyframes since I am replacing the whole block.
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceIn: {
                            '0%': { transform: 'translate(-50%, -100px) scale(0.3)', opacity: '0' },
                            '50%': { transform: 'translate(-50%, 10px) scale(1.1)', opacity: '1' },
                            '100%': { transform: 'translate(-50%, 0) scale(1)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-stone-50 text-slate-900 select-none min-h-screen">
    <div id="root"></div>

    <!-- FIREBASE CONFIGURATION -->
    <script>
        // ‚ö†Ô∏è IMPORTANTE: SUSTITUYE ESTO CON TU CONFIGURACI√ìN DE FIREBASE ‚ö†Ô∏è
        // 1. Ve a https://console.firebase.google.com/
        // 2. Crea un proyecto (o usa uno existente)
        // 3. Ve a Configuraci√≥n del Proyecto (rueda dentada) -> General -> "Tus apps" -> </> (Web)
        // 4. Copia el objeto 'firebaseConfig' y p√©galo aqu√≠ abajo:
        const firebaseConfig = {
            apiKey: "AIzaSyAbZ0qx3Mcw4HzfZN1a-EoAaz4LhViHT6c",
            authDomain: "prueba-app-fitness.firebaseapp.com",
            projectId: "prueba-app-fitness",
            storageBucket: "prueba-app-fitness.firebasestorage.app",
            messagingSenderId: "320494827262",
            appId: "1:320494827262:web:fde9f20d6a87d63f0317af",
            measurementId: "G-KXSJ1FKW5L"
        };

        let db;
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            db.enablePersistence()
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        // Persistence failed: Multiple tabs open
                    } else if (err.code == 'unimplemented') {
                        // Persistence failed: Browser not supported
                    }
                });
            // Firebase initialized
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    </script>

    <!-- Main Application (Inlined) -->
    <script type="text/babel">
        // --- COMPONENTS ---

        // SAFE ICON COMPONENT (Prevents React crashes)
        const Icon = React.memo(({ name, className, ...props }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (!containerRef.current || !window.lucide) return;

                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                if (className) i.setAttribute('class', className);

                containerRef.current.innerHTML = '';
                containerRef.current.appendChild(i);

                window.lucide.createIcons({
                    root: containerRef.current
                });
            }, [name, className]);

            return <span ref={containerRef} style={{ display: 'contents' }}></span>;
        });

        const CalorieTracker = React.memo(({ user, target = 2000 }) => {
            const [calories, setCalories] = React.useState(0);
            const [steps, setSteps] = React.useState(0);
            const [burned, setBurned] = React.useState(0);
            const today = new Date().toISOString().split('T')[0];

            React.useEffect(() => {
                if (!user) return;
                const docRef = db.collection('users').doc(user.uid).collection('daily').doc(today);
                const unsub = docRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setCalories(data.calories || 0);
                        setSteps(data.steps || 0);
                        setBurned(data.burned || 0);
                    } else {
                        setCalories(0);
                        setSteps(0);
                        setBurned(0);
                    }
                });
                return () => unsub();
            }, [user]);

            const updateDailyStat = (field, amount) => {
                const docRef = db.collection('users').doc(user.uid).collection('daily').doc(today);
                docRef.set({
                    [field]: firebase.firestore.FieldValue.increment(amount),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            };

            // --- PEDOMETER LOGIC ---
            const accumulatedStepsRef = React.useRef(0);
            const lastPedometerValRef = React.useRef(null);

            React.useEffect(() => {
                if (!window.pedometer) {
                    // Pedometer not found
                    return;
                }

                // Starting Pedometer
                const successHandler = (data) => {
                    // data.numberOfSteps is total since boot
                    if (lastPedometerValRef.current === null) {
                        lastPedometerValRef.current = data.numberOfSteps;
                        return;
                    }

                    const delta = data.numberOfSteps - lastPedometerValRef.current;
                    if (delta > 0) {
                        accumulatedStepsRef.current += delta;
                        lastPedometerValRef.current = data.numberOfSteps;

                        // Batch updates to DB every 50 steps
                        if (accumulatedStepsRef.current >= 50) {
                            const stepsToAdd = accumulatedStepsRef.current;
                            updateDailyStat('steps', stepsToAdd);
                            // Estimate: 0.04 kcal per step
                            updateDailyStat('burned', stepsToAdd * 0.04);
                            accumulatedStepsRef.current = 0;
                            // Auto-logged steps
                        }
                    }
                };

                window.pedometer.startPedometerUpdates(successHandler, (err) => console.error("Pedometer Error:", err));
            }, []);
            // -----------------------

            // Ensure percentage is always between 0-100, starting from 0
            const percentage = Math.max(0, Math.min((calories / target) * 100, 100));

            return (
                <div className="bg-white rounded-3xl p-6 shadow-[0_4px_20px_rgba(0,0,0,0.02)] border border-stone-100 mb-6 relative overflow-hidden group">
                    {/* Decorative BG */}
                    <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none group-hover:opacity-10 transition-opacity">
                        <i data-lucide="flame" className="w-32 h-32 text-primary-500 -rotate-12 translate-x-8 -translate-y-8"></i>
                    </div>

                    {/* Header Summary */}
                    <div className="flex justify-between items-center mb-6 relative z-10">
                        <div>
                            <h2 className="text-xl font-black text-gray-900 tracking-tight">Resumen Diario</h2>
                            <p className="text-xs text-stone-500 font-bold uppercase tracking-wider">{new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}</p>
                        </div>
                        <div className="bg-stone-100 p-2 rounded-xl">
                            <i data-lucide="activity" className="w-5 h-5 text-stone-600"></i>
                        </div>
                    </div>

                    {/* 1. Intake Progress */}
                    <div className="mb-8 relative z-10">
                        <div className="flex justify-between text-sm mb-2 font-bold">
                            <span className="text-stone-600">Ingesta</span>
                            <span className="text-primary-600 font-black">{calories} / {target} <span className="text-stone-400 text-xs font-medium">kcal</span></span>
                        </div>

                        {/* Progress Bar Container */}
                        <div className={`h-6 w-full bg-stone-100 rounded-full overflow-hidden relative shadow-inner ${percentage > 90 ? 'ring-2 ring-primary-200' : ''}`}>
                            {/* Striped Pattern Overlay */}
                            <div className="absolute inset-0 z-20 opacity-30" style={{ backgroundImage: 'linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent)', backgroundSize: '1rem 1rem' }}></div>

                            {percentage > 0 && (
                                <div
                                    className={`h-full bg-gradient-to-r from-primary-400 to-primary-600 relative z-10 transition-all duration-1000 ease-out flex items-center justification-end pr-2 ${percentage > 90 ? 'animate-pulse' : ''}`}
                                    style={{ width: `${percentage}%` }}
                                >
                                    {percentage > 20 && <div className="ml-auto w-1.5 h-1.5 bg-white/50 rounded-full"></div>}
                                </div>
                            )}
                        </div>

                        <div className="flex gap-2 justify-end mt-4">
                            <button onClick={() => updateDailyStat('calories', 100)} className="group bg-white border border-dashed border-primary-200 text-primary-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-primary-50 transition-all active:scale-95 flex items-center gap-1.5 shadow-sm">
                                <i data-lucide="apple" className="w-3.5 h-3.5 group-hover:scale-110 transition-transform"></i> +100
                            </button>
                            <button onClick={() => updateDailyStat('calories', 250)} className="group bg-primary-500 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-primary-600 shadow-md shadow-primary-500/20 transition-all active:scale-95 flex items-center gap-1.5">
                                <i data-lucide="utensils" className="w-3.5 h-3.5 group-hover:rotate-12 transition-transform"></i> +250
                            </button>
                            <button onClick={() => updateDailyStat('calories', -100)} className="w-8 flex items-center justify-center text-xs text-stone-300 font-bold hover:text-red-400 hover:bg-red-50 rounded-lg transition-colors" title="Corregir">
                                <i data-lucide="rotate-ccw" className="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    {/* 2. Activity Section (Cards) */}
                    <div className="grid grid-cols-2 gap-4 relative z-10">
                        {/* Steps - Circular Progress */}
                        <div className="bg-gradient-to-br from-blue-50 to-cyan-50 p-5 rounded-2xl border border-blue-100 hover:shadow-lg transition-all group/card relative overflow-hidden">
                            {/* Background decoration */}
                            <div className="absolute -right-4 -bottom-4 w-24 h-24 bg-blue-200/20 rounded-full blur-2xl"></div>

                            <div className="relative z-10">
                                <div className="flex items-center gap-2 mb-4">
                                    <div className="p-1.5 bg-blue-500 rounded-lg text-white">
                                        <i data-lucide="footprints" className="w-3.5 h-3.5"></i>
                                    </div>
                                    <span className="text-xs font-bold text-blue-900 uppercase tracking-wider">Pasos Hoy</span>
                                </div>

                                {/* Circular Progress */}
                                <div className="flex items-center justify-center mb-4">
                                    <div className="relative w-28 h-28">
                                        {/* Background circle */}
                                        <svg className="w-full h-full transform -rotate-90">
                                            <circle
                                                cx="56"
                                                cy="56"
                                                r="50"
                                                stroke="currentColor"
                                                strokeWidth="8"
                                                fill="none"
                                                className="text-blue-100"
                                            />
                                            {/* Progress circle */}
                                            <circle
                                                cx="56"
                                                cy="56"
                                                r="50"
                                                stroke="url(#stepGradient)"
                                                strokeWidth="8"
                                                fill="none"
                                                strokeLinecap="round"
                                                strokeDasharray={`${2 * Math.PI * 50}`}
                                                strokeDashoffset={`${2 * Math.PI * 50 * (1 - Math.min(steps / 10000, 1))}`}
                                                className="transition-all duration-1000 ease-out"
                                            />
                                            <defs>
                                                <linearGradient id="stepGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                    <stop offset="0%" stopColor="#3B82F6" />
                                                    <stop offset="100%" stopColor="#06B6D4" />
                                                </linearGradient>
                                            </defs>
                                        </svg>
                                        {/* Center text */}
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <div className="text-3xl font-black text-blue-700 leading-none">
                                                {steps > 1000 ? (steps / 1000).toFixed(1) : steps}
                                            </div>
                                            <div className="text-[9px] text-blue-400 font-bold mt-0.5">
                                                {steps > 1000 ? 'MIL' : 'pasos'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Goal text */}
                                <div className="text-center mb-3">
                                    <div className="text-[10px] text-blue-500 font-bold">
                                        Meta: 10,000 ‚Ä¢ {Math.round((steps / 10000) * 100)}%
                                    </div>
                                </div>

                                {/* Quick add buttons */}
                                <div className="flex gap-1.5">
                                    <button onClick={() => { updateDailyStat('steps', 500); updateDailyStat('burned', 20); }} className="flex-1 bg-white/80 backdrop-blur shadow-sm border border-blue-200 py-1.5 rounded-lg text-[10px] font-bold text-blue-600 hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all active:scale-95">+500</button>
                                    <button onClick={() => { updateDailyStat('steps', 1000); updateDailyStat('burned', 40); }} className="flex-1 bg-white/80 backdrop-blur shadow-sm border border-blue-200 py-1.5 rounded-lg text-[10px] font-bold text-blue-600 hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all active:scale-95">+1k</button>
                                </div>
                            </div>
                        </div>

                        {/* Burned */}
                        <div className="bg-orange-50/50 p-4 rounded-2xl border border-orange-100 hover:bg-orange-50 transition-colors group/card">
                            <div className="flex items-center gap-2 mb-3">
                                <div className="p-2 bg-orange-100/50 rounded-lg text-orange-500 group-hover/card:bg-orange-500 group-hover/card:text-white transition-colors">
                                    <i data-lucide="flame" className="w-4 h-4"></i>
                                </div>
                                <span className="text-xs font-bold text-orange-800 uppercase tracking-wider">Kcal Total</span>
                            </div>
                            <div className="flex items-end gap-1 mb-3">
                                <div className="text-2xl font-black text-orange-600 leading-none">{Math.round(burned)}</div>
                            </div>
                            <div className="w-full bg-orange-200/50 h-1.5 rounded-full overflow-hidden">
                                <div className="h-full bg-orange-500 rounded-full transition-all duration-1000" style={{ width: `${Math.min((burned / 500) * 100, 100)}%` }}></div>
                                {/* Just visual placeholder since this is auto-calculated */}
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        const ProgressChart = React.memo(({ routineName, dataPoints }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                const ctx = chartRef.current.getContext('2d');
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();

                const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(230, 57, 70, 0.5)');
                gradient.addColorStop(1, 'rgba(230, 57, 70, 0.0)');

                chartInstanceRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                        datasets: [{
                            label: 'Volumen',
                            data: dataPoints,
                            borderColor: '#E63946',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#E63946',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(28, 25, 23, 0.9)', // stone-900
                                titleFont: { family: 'Inter', size: 12 },
                                bodyFont: { family: 'Inter', size: 12, weight: 'bold' },
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    label: function (context) {
                                        return context.parsed.y + ' kg total';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { display: false },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10, family: 'Inter' }, color: '#a8a29e' } // stone-400
                            }
                        }
                    }
                });
                return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); }
            }, [dataPoints]);

            return (
                <div className="bg-white rounded-3xl p-6 shadow-sm border border-stone-100 mb-8">
                    <div className="mb-6 flex justify-between items-end">
                        <div className="flex flex-col">
                            <h3 className="font-black text-gray-900 text-lg flex items-center gap-2">
                                <div className="p-1.5 bg-green-100 rounded-lg text-green-600">
                                    <i data-lucide="trending-up" className="w-4 h-4"></i>
                                </div>
                                {routineName}
                            </h3>
                            <p className="text-xs text-stone-400 font-medium ml-9">Tendencia de volumen (√∫ltimo mes)</p>
                        </div>
                    </div>
                    <div className="h-48 w-full">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        });

        // --- GAMIFICATION COMPONENTS ---

        const LEVELS = [
            { name: 'Novato', min: 0, max: 100, icon: 'üå±', color: 'from-gray-400 to-gray-500' },
            { name: 'Aprendiz', min: 101, max: 500, icon: 'üí™', color: 'from-blue-400 to-blue-600' },
            { name: 'Experto', min: 501, max: 1500, icon: 'üî•', color: 'from-orange-400 to-red-500' },
            { name: 'Maestro', min: 1501, max: Infinity, icon: 'üëë', color: 'from-purple-500 to-pink-600' }
        ];

        const BADGES = [
            { id: 'first_workout', name: 'Primer Paso', icon: 'üéØ', description: 'Completa tu primer entrenamiento', criteria: (stats) => stats.totalWorkouts >= 1 },
            { id: 'streak_7', name: 'Racha de Fuego', icon: 'üî•', description: '7 d√≠as consecutivos', criteria: (stats) => stats.streakDays >= 7 },
            { id: 'streak_30', name: 'Imparable', icon: '‚ö°', description: '30 d√≠as consecutivos', criteria: (stats) => stats.streakDays >= 30 },
            { id: 'pr_5', name: 'Rompe R√©cords', icon: 'üí•', description: 'Consigue 5 PRs', criteria: (stats) => stats.totalPRs >= 5 },
            { id: 'pr_20', name: 'Bestia de Hierro', icon: 'ü¶æ', description: 'Consigue 20 PRs', criteria: (stats) => stats.totalPRs >= 20 },
            { id: 'workouts_50', name: 'Dedicaci√≥n', icon: 'üèãÔ∏è', description: '50 entrenamientos completados', criteria: (stats) => stats.totalWorkouts >= 50 },
            { id: 'workouts_100', name: 'Centuri√≥n', icon: 'üéñÔ∏è', description: '100 entrenamientos completados', criteria: (stats) => stats.totalWorkouts >= 100 },
        ];

        const getCurrentLevel = (points) => {
            return LEVELS.findIndex(l => points >= l.min && points <= l.max);
        };

        const getLevelProgress = (points) => {
            const levelIndex = getCurrentLevel(points);
            const level = LEVELS[levelIndex];
            if (levelIndex === LEVELS.length - 1) return 100; // Maestro = 100%
            const progress = ((points - level.min) / (level.max - level.min)) * 100;
            return Math.min(progress, 100);
        };

        const LevelBadge = ({ stats, onClick }) => {
            const levelIndex = getCurrentLevel(stats.points);
            const level = LEVELS[levelIndex];
            const progress = getLevelProgress(stats.points);
            const nextLevel = LEVELS[levelIndex + 1];

            return (
                <div onClick={onClick} className="cursor-pointer group">
                    <div className="flex items-center gap-2 bg-gradient-to-r from-gray-50 to-gray-100 px-3 py-1.5 rounded-full border border-gray-200 hover:border-primary-300 transition-all hover:shadow-md">
                        <span className="text-lg">{level.icon}</span>
                        <div className="flex flex-col">
                            <span className="text-[10px] font-black text-gray-700 leading-none">{level.name}</span>
                            <span className="text-[9px] text-gray-400 leading-none">{stats.points} pts</span>
                        </div>
                    </div>
                    {nextLevel && (
                        <div className="mt-1 w-full bg-gray-200 rounded-full h-1 overflow-hidden">
                            <div
                                className={`h-full bg-gradient-to-r ${level.color} transition-all duration-500`}
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>
                    )}
                </div>
            );
        };

        const PointsPopup = ({ amount, reason, onComplete }) => {
            React.useEffect(() => {
                const timer = setTimeout(onComplete, 2000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-[200] animate-bounce-in">
                    <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-2xl shadow-2xl border-2 border-white">
                        <div className="text-center">
                            <div className="text-2xl font-black">+{amount} pts</div>
                            <div className="text-xs font-medium opacity-90">{reason}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const BadgesModal = ({ stats, onClose }) => {
            const earnedBadges = BADGES.filter(b => stats.badges.includes(b.id));
            const lockedBadges = BADGES.filter(b => !stats.badges.includes(b.id));

            return (
                <div onClick={onClose} className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-fade-in">
                    <div onClick={e => e.stopPropagation()} className="bg-white rounded-3xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-2xl animate-scale-in">
                        <div className="bg-gradient-to-r from-purple-500 to-pink-600 p-6 text-white">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h3 className="text-2xl font-black">Tus Logros</h3>
                                    <p className="text-sm opacity-90">{earnedBadges.length} de {BADGES.length} desbloqueados</p>
                                </div>
                                <button onClick={onClose} className="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors">
                                    <i data-lucide="x" className="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[60vh]">
                            {earnedBadges.length > 0 && (
                                <div className="mb-6">
                                    <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Desbloqueados</h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        {earnedBadges.map(badge => (
                                            <div key={badge.id} className="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-400 rounded-2xl p-4 text-center transform hover:scale-105 transition-transform">
                                                <div className="text-4xl mb-2">{badge.icon}</div>
                                                <div className="text-sm font-bold text-gray-800">{badge.name}</div>
                                                <div className="text-xs text-gray-500 mt-1">{badge.description}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {lockedBadges.length > 0 && (
                                <div>
                                    <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Bloqueados</h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        {lockedBadges.map(badge => (
                                            <div key={badge.id} className="bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 text-center opacity-50">
                                                <div className="text-4xl mb-2 grayscale">{badge.icon}</div>
                                                <div className="text-sm font-bold text-gray-600">{badge.name}</div>
                                                <div className="text-xs text-gray-400 mt-1">{badge.description}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- BODY MAP COMPONENT REMOVED BY USER REQUEST ---

        // --- GOAL PREDICTION COMPONENT ---

        const GoalPrediction = ({ exercise, logs }) => {
            const userLog = logs[exercise.id];
            const savedGoal = userLog ? userLog.goalWeight : null;
            const initialGoal = savedGoal || (exercise.max1RM + 20) || 100;

            const [goalWeight, setGoalWeight] = React.useState(initialGoal);
            const [showInput, setShowInput] = React.useState(false);

            // Calculate linear regression from historical data
            const prediction = React.useMemo(() => {
                const userLog = logs[exercise.id];
                if (!userLog || !userLog.sets || userLog.sets.length < 3) {
                    return null; // Not enough data
                }

                // Extract 1RM history (simplified: use current sets as proxy for history)
                const dataPoints = userLog.sets
                    .filter(s => s.weight > 0 && s.reps > 0)
                    .map((s, index) => ({
                        x: index, // Time proxy (set index)
                        y: Math.round(s.weight * (1 + s.reps / 30)) // Epley 1RM
                    }));

                if (dataPoints.length < 2) return null;

                // Linear regression: y = mx + b
                const n = dataPoints.length;
                const sumX = dataPoints.reduce((sum, p) => sum + p.x, 0);
                const sumY = dataPoints.reduce((sum, p) => sum + p.y, 0);
                const sumXY = dataPoints.reduce((sum, p) => sum + (p.x * p.y), 0);
                const sumX2 = dataPoints.reduce((sum, p) => sum + (p.x * p.x), 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                // Current max 1RM
                const currentMax = exercise.max1RM || dataPoints[dataPoints.length - 1].y;

                // If slope is negative or zero, can't predict
                if (slope <= 0) {
                    return { canPredict: false, reason: 'No hay progreso detectado' };
                }

                // Calculate weeks to goal (assuming 1 set = 1 week proxy)
                const setsToGoal = (goalWeight - currentMax) / slope;
                const weeksToGoal = Math.max(1, Math.ceil(setsToGoal));

                // Calculate R¬≤ (coefficient of determination) for confidence
                const yMean = sumY / n;
                const ssTotal = dataPoints.reduce((sum, p) => sum + Math.pow(p.y - yMean, 2), 0);
                const ssResidual = dataPoints.reduce((sum, p) => {
                    const predicted = slope * p.x + intercept;
                    return sum + Math.pow(p.y - predicted, 2);
                }, 0);
                const rSquared = 1 - (ssResidual / ssTotal);

                // Confidence level
                let confidence = 'Baja';
                let confidenceColor = 'text-red-500';
                if (rSquared > 0.7) {
                    confidence = 'Alta';
                    confidenceColor = 'text-green-500';
                } else if (rSquared > 0.4) {
                    confidence = 'Media';
                    confidenceColor = 'text-yellow-500';
                }

                // Projected date
                const projectedDate = new Date();
                projectedDate.setDate(projectedDate.getDate() + (weeksToGoal * 7));

                return {
                    canPredict: true,
                    currentMax,
                    goalWeight,
                    weeksToGoal,
                    projectedDate: projectedDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
                    confidence,
                    confidenceColor,
                    progressPerWeek: slope.toFixed(1)
                };
            }, [exercise, logs, goalWeight]);

            if (!prediction) {
                return (
                    <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-4 border border-purple-200">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <i data-lucide="target" className="w-5 h-5 text-purple-600"></i>
                            </div>
                            <div className="flex-1">
                                <h4 className="font-bold text-gray-800 text-sm">Predicci√≥n de Meta</h4>
                                <p className="text-xs text-gray-500">Completa m√°s series para ver tu proyecci√≥n</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!prediction.canPredict) {
                return (
                    <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-4 border border-gray-200">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <i data-lucide="trending-down" className="w-5 h-5 text-gray-500"></i>
                            </div>
                            <div className="flex-1">
                                <h4 className="font-bold text-gray-700 text-sm">Sin Progreso</h4>
                                <p className="text-xs text-gray-500">{prediction.reason}</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-4 border-2 border-purple-300 shadow-sm">
                    <div className="flex items-start gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shrink-0">
                            <i data-lucide="target" className="w-6 h-6 text-white"></i>
                        </div>
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                                <h4 className="font-black text-gray-900 text-sm">Meta: {goalWeight}kg</h4>
                                <button
                                    onClick={() => setShowInput(!showInput)}
                                    className="w-5 h-5 bg-white rounded-full flex items-center justify-center hover:bg-gray-100 transition-colors"
                                >
                                    <i data-lucide="edit-2" className="w-3 h-3 text-purple-600"></i>
                                </button>
                            </div>

                            {showInput && (
                                <div className="mb-3 flex gap-2">
                                    <input
                                        type="number"
                                        value={goalWeight}
                                        onChange={(e) => setGoalWeight(parseInt(e.target.value) || 100)}
                                        className="w-20 px-2 py-1 text-sm border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                                    />
                                    <button
                                        onClick={() => {
                                            setShowInput(false);
                                            // Save to Firestore
                                            if (logs && logs[exercise.id]) {
                                                const docRef = db.collection('users').doc(firebase.auth().currentUser.uid).collection('logs').doc(exercise.id);
                                                docRef.set({ goalWeight: goalWeight }, { merge: true });
                                            }
                                        }}
                                        className="px-3 py-1 bg-purple-500 text-white text-xs font-bold rounded-lg hover:bg-purple-600 transition-colors"
                                    >
                                        OK
                                    </button>
                                </div>
                            )}

                            <div className="space-y-1">
                                <div className="flex items-center gap-2">
                                    <i data-lucide="calendar" className="w-4 h-4 text-purple-600"></i>
                                    <p className="text-sm font-bold text-gray-800">
                                        Llegar√°s en <span className="text-purple-600">~{prediction.weeksToGoal} semanas</span>
                                    </p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <i data-lucide="flag" className="w-4 h-4 text-pink-600"></i>
                                    <p className="text-xs text-gray-600">
                                        Fecha estimada: <span className="font-bold">{prediction.projectedDate}</span>
                                    </p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Icon name="trending-up" className="w-4 h-4 text-green-600" />
                                    <p className="text-xs text-gray-600">
                                        Progreso: <span className="font-bold">+{prediction.progressPerWeek}kg/semana</span>
                                    </p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Icon name="gauge" className="w-4 h-4 text-blue-600" />
                                    <p className="text-xs text-gray-600">
                                        Confianza: <span className={`font-bold ${prediction.confidenceColor}`}>{prediction.confidence}</span>
                                    </p>
                                </div>
                            </div>

                            <div className="mt-3 bg-white/50 rounded-lg p-2">
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-gray-500">Actual: {prediction.currentMax}kg</span>
                                    <span className="text-purple-600 font-bold">Meta: {goalWeight}kg</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div
                                        className="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-500"
                                        style={{ width: `${Math.min((prediction.currentMax / goalWeight) * 100, 100)}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ExerciseCard = React.memo(({ exercise, logs, userProfile, onUpdateSet, onAddSet, onRemoveSet, onOpenCalc, onOpenChart, onEdit, onDelete }) => {
            const [isOpen, setIsOpen] = React.useState(false);

            // Calculate active volume (just for fun/display)
            const activeVolume = exercise.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
            const totalSets = exercise.sets.length;
            const maxWeight = Math.max(...exercise.sets.map(s => parseInt(s.weight) || 0));

            // Relative Strength Ratio
            const bwRatio = (userProfile && userProfile.weight && exercise.max1RM)
                ? (exercise.max1RM / userProfile.weight).toFixed(2)
                : null;

            return (
                <div className="bg-white rounded-3xl shadow-sm border border-stone-100 overflow-hidden transition-all duration-300 hover:shadow-md mb-4 group">
                    {/* Header */}
                    <div onClick={() => setIsOpen(!isOpen)} className="p-6 flex gap-4 items-center cursor-pointer hover:bg-stone-50/50 transition-colors relative">
                        {/* Settings Button (Cog) */}
                        <button
                            onClick={(e) => { e.stopPropagation(); onEdit(exercise); }}
                            className="absolute top-2 right-2 p-2 text-stone-300 hover:text-stone-500 rounded-full hover:bg-stone-100 transition-colors z-[30]"
                        >
                            <Icon name="settings-2" className="w-4 h-4" />
                        </button>
                        <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center overflow-hidden shrink-0 border border-stone-100 shadow-sm group-hover:scale-105 transition-transform duration-300">
                            <img src={exercise.img} alt={exercise.name} className="w-full h-full object-cover mix-blend-multiply opacity-90 group-hover:opacity-100" />
                        </div>
                        <div className="flex-1">
                            <h4 className="font-bold text-gray-900 text-lg mb-1 leading-tight group-hover:text-primary-600 transition-colors">{exercise.name}</h4>
                            <div className="flex gap-2 text-xs items-center flex-wrap">
                                <span className="text-stone-500 font-medium flex items-center gap-1">
                                    <Icon name="dumbbell" className="w-3 h-3" /> {exercise.muscle}
                                </span>
                                <span className="text-stone-300">‚Ä¢</span>
                                <span className="text-stone-500 font-medium">{totalSets} Series</span>
                                {exercise.max1RM > 0 && (
                                    <div className="flex gap-1 items-center ml-1">
                                        <span className="bg-orange-50 text-orange-600 border border-orange-100 px-1.5 py-0.5 rounded-md font-bold text-[10px] flex items-center gap-1">
                                            <Icon name="trophy" className="w-3 h-3" /> {exercise.max1RM}kg
                                        </span>
                                        {bwRatio && (
                                            <span className="bg-indigo-50 text-indigo-600 border border-indigo-100 px-1.5 py-0.5 rounded-md font-bold text-[10px]" title="Veces tu peso corporal">
                                                {bwRatio}x BW
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2 relative z-20" onClick={e => e.stopPropagation()}>
                            <button onClick={e => { e.stopPropagation(); onOpenCalc(exercise.defaultWeight || 60); }} className="p-2.5 bg-stone-50 hover:bg-stone-100 rounded-xl text-stone-500 transition-colors" title="Calculadora Discos">
                                <Icon name="disc" className="w-5 h-5" />
                            </button>
                            <button onClick={e => { e.stopPropagation(); onOpenChart(exercise.id, exercise.name); }} className="p-2.5 bg-stone-50 hover:bg-stone-100 rounded-xl text-stone-500 transition-colors" title="Ver Gr√°fica">
                                <Icon name="line-chart" className="w-5 h-5" />
                            </button>
                        </div>
                        <div className={`w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 transform transition-transform duration-300 ${isOpen ? 'rotate-180 bg-stone-100' : ''}`}>
                            <Icon name="chevron-down" className="w-5 h-5 text-stone-400" />
                        </div>
                    </div>

                    {/* Sets Table */}
                    <div className={`bg-stone-50/30 border-t border-stone-100 transition-all duration-300 ease-in-out ${isOpen ? 'max-h-[800px] opacity-100 pb-4' : 'max-h-0 opacity-0 overflow-hidden'}`}>
                        <div className="px-6 pt-4 pb-2">
                            <div className="grid grid-cols-12 gap-3 mb-3 text-[10px] items-center text-stone-400 font-bold uppercase tracking-wider text-center">
                                <span className="col-span-1">#</span>
                                <span className="col-span-3 text-left pl-2">Tipo</span>
                                <span className="col-span-3">Kg</span>
                                <span className="col-span-3">Reps</span>
                                <span className="col-span-2">‚úì</span>
                            </div>

                            <div className="space-y-3">
                                {exercise.sets.map((set, index) => (
                                    <div key={set.id} className={`grid grid-cols-12 gap-3 items-center group/set ${set.isCompleted ? 'opacity-60 saturate-50' : ''}`}>
                                        <div className="col-span-1 flex justify-center">
                                            <div className="w-6 h-6 rounded-full bg-white border border-stone-200 text-stone-400 flex items-center justify-center text-[10px] font-bold shadow-sm">
                                                {index + 1}
                                            </div>
                                        </div>
                                        <div className="col-span-3">
                                            <select
                                                value={set.type || 'working'}
                                                onChange={(e) => onUpdateSet(exercise.id, set.id, 'type', e.target.value)}
                                                className="w-full bg-white border border-stone-200 rounded-lg py-1.5 px-2 text-[10px] font-bold text-stone-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all appearance-none"
                                            >
                                                <option value="warmup">üî• Cal</option>
                                                <option value="approach">‚ö° Apr</option>
                                                <option value="working">üí™ Efe</option>
                                            </select>
                                        </div>
                                        <div className="col-span-3 relative">
                                            <input
                                                type="number"
                                                min="0"
                                                max="600"
                                                step="0.5"
                                                value={set.weight}
                                                onChange={(e) => onUpdateSet(exercise.id, set.id, 'weight', e.target.value)}
                                                className="w-full text-center bg-white border border-stone-200 rounded-xl py-2 text-sm font-bold text-stone-800 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all shadow-sm group-hover/set:border-blue-200"
                                            />
                                        </div>
                                        <div className="col-span-3">
                                            <input
                                                type="number"
                                                min="0"
                                                max="100"
                                                value={set.reps}
                                                onChange={(e) => onUpdateSet(exercise.id, set.id, 'reps', e.target.value)}
                                                className="w-full text-center bg-white border border-stone-200 rounded-xl py-2 text-sm font-bold text-stone-800 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all shadow-sm group-hover/set:border-blue-200"
                                            />
                                        </div>
                                        <div className="col-span-2 flex justify-center">
                                            <button
                                                onClick={() => onUpdateSet(exercise.id, set.id, 'isCompleted', !set.isCompleted)}
                                                className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300 active:scale-90 ${set.isCompleted ? 'bg-green-500 text-white shadow-lg shadow-green-200 rotate-0' : 'bg-stone-100 text-stone-300 hover:bg-stone-200 hover:text-stone-400'}`}
                                            >
                                                <Icon name="check" className={`w-5 h-5 stroke-[3px] transition-transform ${set.isCompleted ? 'scale-110' : 'scale-100'}`} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-6 flex gap-3">
                                <button
                                    onClick={() => onAddSet(exercise.id)}
                                    className="flex-1 py-3 bg-white border border-stone-200 text-stone-600 rounded-xl text-xs font-bold hover:bg-primary-50 hover:text-primary-600 hover:border-primary-100 transition-all shadow-sm flex items-center justify-center gap-2 group/btn"
                                >
                                    <div className="w-5 h-5 bg-stone-100 rounded-full flex items-center justify-center group-hover/btn:bg-primary-100 transition-colors">
                                        <Icon name="plus" className="w-3 h-3" />
                                    </div>
                                    A√±adir Serie
                                </button>
                                {exercise.sets.length > 0 && (
                                    <button
                                        onClick={() => onRemoveSet(exercise.id)}
                                        className="w-12 flex items-center justify-center py-3 bg-white border border-stone-200 text-stone-400 rounded-xl hover:bg-red-50 hover:text-red-500 hover:border-red-100 transition-colors shadow-sm"
                                    >
                                        <Icon name="trash-2" className="w-4 h-4" />
                                    </button>
                                )}
                            </div>

                            {/* Goal Prediction */}
                            <div className="mt-6">
                                <GoalPrediction exercise={exercise} logs={logs} />
                            </div>
                        </div>
                    </div>
                </div >
            );
        });

        const RestTimer = ({ initialTime, isActive, onComplete, onCancel }) => {
            const [timeLeft, setTimeLeft] = React.useState(initialTime);

            React.useEffect(() => {
                let interval;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0) {
                    onComplete();
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, onComplete]);

            // Reset when initialTime changes (new set)
            React.useEffect(() => {
                if (isActive) setTimeLeft(initialTime);
            }, [initialTime, isActive]);

            if (!isActive) return null;

            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl z-[60] flex items-center gap-4 animate-slide-up border border-gray-700">
                    <div className="flex flex-col">
                        <span className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Descanso</span>
                        <span className="text-xl font-mono font-bold leading-none">{Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}</span>
                    </div>
                    <button onClick={onCancel} className="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-full transition-colors">
                        <Icon name="x" className="w-4 h-4" />
                    </button>
                </div>
            );
        };

        // --- AUTH COMPONENTS ---

        const Login = ({ onLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [nickname, setNickname] = React.useState(''); // New Nickname State
            const [isRegistering, setIsRegistering] = React.useState(false);
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    if (isRegistering) {
                        // Validate Nickname
                        if (!nickname || nickname.length < 3) {
                            throw new Error("El nickname debe tener al menos 3 caracteres.");
                        }
                        const cleanNick = nickname.toLowerCase().replace(/\s/g, '');
                        if (cleanNick !== nickname.toLowerCase()) {
                            throw new Error("El nickname no puede tener espacios.");
                        }

                        // Check Uniqueness
                        const nickDoc = await db.collection('usernames').doc(cleanNick).get();
                        if (nickDoc.exists) {
                            throw new Error("Este nickname ya est√° en uso. Elige otro.");
                        }

                        // Register Flow
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;

                        // Set Display Name (Nickname)
                        await user.updateProfile({ displayName: nickname });

                        // Reserve Nickname & Create User Docs
                        const batch = db.batch();

                        // 1. Reserve Nickname
                        const nickRef = db.collection('usernames').doc(cleanNick);
                        batch.set(nickRef, { uid: user.uid, original: nickname });

                        // 2. Pending User (still good for admin visibility, even if no gate)
                        const pendingRef = db.collection('pending_users').doc(user.uid);
                        batch.set(pendingRef, {
                            email: user.email,
                            uid: user.uid,
                            nickname: nickname,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // 3. users_public (for social search)
                        const safeEmail = user.email.replace(/\./g, '_');
                        const publicRef = db.collection('users_public').doc(safeEmail);
                        batch.set(publicRef, {
                            uid: user.uid,
                            email: user.email,
                            nickname: nickname,
                            name: nickname, // Use nickname as display name
                            level: 0,
                            photo: `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`
                        });

                        await batch.commit();

                        // Notify n8n (Registration Webhook) - ULTIMATE TEST: GET REQUEST
                        try {
                            const params = new URLSearchParams({
                                event: 'new_registration',
                                email: user.email,
                                userId: user.uid,
                                nickname: nickname
                            });
                            // Using GET + no-cors is virtually impossible to block
                            await fetch(`https://danitorre.app.n8n.cloud/webhook-test/firebase-events?${params.toString()}`, {
                                method: 'GET',
                                mode: 'no-cors'
                            });
                        } catch (webhookErr) {
                            console.error("Webhook trigger failed (non-blocking):", webhookErr);
                        }

                        // Auth state listener will handle redirection (user is logged in)
                    } else {
                        // Login Flow
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                    }
                } catch (err) {
                    console.error(err);
                    setError(err.message || 'Error de autenticaci√≥n.');
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-white">
                    <div className="w-full max-w-sm space-y-8 animate-fade-in">
                        <div className="text-center">
                            <h1 className="text-3xl font-black text-gray-900 tracking-tight mb-2">
                                Antigravity<span className="text-primary-500">.</span>
                            </h1>
                            <p className="text-gray-500">{isRegistering ? 'Crea tu cuenta para empezar' : 'Inicia sesi√≥n para entrenar'}</p>
                        </div>

                        {error && (
                            <div className="bg-red-50 text-red-500 p-4 rounded-xl text-sm font-medium border border-red-100 flex items-center gap-2">
                                <Icon name="alert-circle" className="w-4 h-4" />
                                {error}
                            </div>
                        )}
                        {/* Warning about Config */}
                        {firebaseConfig.apiKey === "API_KEY_AQUI" && (
                            <div className="bg-yellow-50 text-yellow-700 p-4 rounded-xl text-xs border border-yellow-200">
                                <strong>‚ö†Ô∏è Configuraci√≥n Faltante:</strong><br />
                                Abre el archivo <code>index.html</code> y pega tu configuraci√≥n de Firebase en la l√≠nea 78.
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {isRegistering && (
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Nickname (√önico)</label>
                                    <input
                                        type="text"
                                        required
                                        value={nickname}
                                        onChange={(e) => setNickname(e.target.value)}
                                        placeholder="TuApodoFitness"
                                        className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all font-medium"
                                    />
                                    <p className="text-[10px] text-gray-400 mt-1 ml-1">Sin espacios. Ser√° tu nombre p√∫blico.</p>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="usuario@ejemplo.com"
                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all font-medium"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Contrase√±a</label>
                                <input
                                    type="password"
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all font-medium"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-primary-600 text-white rounded-xl py-4 font-bold text-lg shadow-lg shadow-primary-500/30 hover:bg-primary-700 hover:shadow-primary-500/40 active:scale-[0.98] transition-all flex items-center justify-center gap-2"
                            >
                                {loading ? <Icon name="loader-2" className="w-5 h-5 animate-spin" /> : (isRegistering ? 'Registrarse' : 'Entrar')}
                            </button>
                        </form>

                        <div className="text-center">
                            <button
                                onClick={() => { setIsRegistering(!isRegistering); setError(''); }}
                                className="text-sm font-bold text-primary-600 hover:text-primary-700 transition-colors"
                            >
                                {isRegistering ? '¬øYa tienes cuenta? Inicia sesi√≥n' : '¬øNo tienes cuenta? Reg√≠strate'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PlateCalculatorModal = ({ initialWeight, onClose }) => {
            const [weight, setWeight] = React.useState(initialWeight || 60);

            const plates = [25, 20, 15, 10, 5, 2.5, 1.25];
            const plateColors = {
                25: 'bg-red-600 h-24', 20: 'bg-blue-600 h-24', 15: 'bg-yellow-500 h-20',
                10: 'bg-green-600 h-16', 5: 'bg-white border-2 border-gray-300 h-12',
                2.5: 'bg-gray-800 h-10', 1.25: 'bg-gray-400 h-8'
            };

            const calculatePlates = () => {
                let remainder = (weight - 20) / 2; // Per side, assuming 20kg bar
                if (remainder < 0) return [];
                const result = [];
                plates.forEach(p => {
                    while (remainder >= p) {
                        result.push(p);
                        remainder -= p;
                    }
                });
                return result;
            };

            const resultPlates = calculatePlates();

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icon name="x" className="w-5 h-5" /></button>

                        <h3 className="text-xl font-black mb-6 flex items-center gap-2"><Icon name="disc" className="w-6 h-6 text-primary-500" /> Discos</h3>

                        <div className="mb-8">
                            <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Peso Total (Barra 20kg)</label>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setWeight(Math.max(20, weight - 2.5))} className="p-3 bg-gray-100 rounded-xl font-bold">-2.5</button>
                                <input
                                    type="number"
                                    value={weight}
                                    onChange={e => setWeight(Number(e.target.value))}
                                    className="flex-1 text-center text-3xl font-black border-2 border-gray-200 rounded-xl py-2 focus:border-primary-500 outline-none"
                                />
                                <button onClick={() => setWeight(weight + 2.5)} className="p-3 bg-gray-100 rounded-xl font-bold">+2.5</button>
                            </div>
                        </div>

                        {/* Visual Bar */}
                        <div className="bg-gray-100 rounded-2xl p-6 mb-6 flex items-center justify-start overflow-x-auto relative h-32">
                            {/* Bar shaft */}
                            <div className="absolute left-0 right-0 h-4 bg-gray-400 z-0"></div>
                            {/* Collar */}
                            <div className="w-4 h-6 bg-gray-500 z-10 mr-1 flex-shrink-0"></div>

                            {resultPlates.length === 0 ? <span className="text-xs font-bold text-gray-400 absolute top-2 left-2">Barra vac√≠a</span> : null}

                            {resultPlates.map((p, i) => (
                                <div key={i} className={`w-8 ${plateColors[p]} rounded-sm z-10 mr-1 shadow-md border-r border-black/10 flex items-center justify-center text-[10px] font-bold text-white/90`}>
                                    <span className="-rotate-90">{p}</span>
                                </div>
                            ))}
                        </div>

                        <div className="bg-primary-50 p-4 rounded-xl">
                            <p className="text-center font-bold text-primary-900 text-sm">
                                {resultPlates.length > 0
                                    ? `Pon: ${resultPlates.map(p => `${p}kg`).join(' + ')} por lado`
                                    : "Solo la barra (20kg)"}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const ExerciseChartModal = ({ exerciseId, exerciseName, logs, onClose }) => {
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                if (!canvasRef.current || !window.Chart) return;

                // Process Logs -> [ {x: date, y: 1rm}, ... ]
                const exerciseLogs = logs[exerciseId] ? logs[exerciseId].sets : [];
                // Group sets by Date (hacky way using timestamp approx or real dates if available)
                // Since we store simple "sets" array in logs[id], we might not have date per set easily accessible 
                // unless we assume logs are chronological or stored differently. 
                // WAIT: The current data model `logs` is just `{ exerciseId: { sets: [...] } }`. 
                // The `sets` have `id` (timestamp). We can assume `id` is the date created.

                // Aggregate by Day
                const dailyMax = {};
                exerciseLogs.forEach(set => {
                    const date = new Date(set.id).toLocaleDateString(); // Simple grouping
                    const rm = set.weight * (1 + set.reps / 30);
                    if (!dailyMax[date] || rm > dailyMax[date]) {
                        dailyMax[date] = rm;
                    }
                });

                const dataPoints = Object.keys(dailyMax).map(date => ({
                    x: date,
                    y: Math.round(dailyMax[date])
                })); // Sort might be needed but Object.keys usually preserves set order if inserted chrono.

                const ctx = canvasRef.current.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataPoints.map(d => d.x.split('/')[0] + '/' + d.x.split('/')[1]), // Day/Month
                        datasets: [{
                            label: '1RM Estimado (kg)',
                            data: dataPoints.map(d => d.y),
                            borderColor: '#E63946',
                            backgroundColor: 'rgba(230, 57, 70, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#E63946'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(29, 53, 87, 0.9)',
                                titleFont: { family: 'Inter' },
                                bodyFont: { family: 'Inter' }
                            }
                        },
                        scales: {
                            y: { grid: { display: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                return () => chart.destroy();
            }, [exerciseId, logs]);



            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icon name="x" className="w-5 h-5" /></button>
                        <h3 className="text-xl font-black mb-2">{exerciseName}</h3>
                        <p className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-6">Progreso de Fuerza (1RM)</p>
                        <div className="relative h-64 w-full">
                            <canvas ref={canvasRef}></canvas>
                        </div>
                    </div>
                </div>
            );
        };

        const CreateRoutineModal = ({ user, onClose, onSave }) => {
            const [name, setName] = React.useState('');
            const [selectedIcon, setSelectedIcon] = React.useState('dumbbell');
            const [selectedColor, setSelectedColor] = React.useState('red');
            const [loading, setLoading] = React.useState(false);



            const icons = [
                { id: 'dumbbell', label: 'Pesas' },
                { id: 'zap', label: 'Energ√≠a' },
                { id: 'flame', label: 'Fuego' },
                { id: 'heart', label: 'Coraz√≥n' },
                { id: 'target', label: 'Diana' },
                { id: 'activity', label: 'Actividad' },
                { id: 'trophy', label: 'Trofeo' },
                { id: 'star', label: 'Estrella' }
            ];

            const colors = [
                { id: 'red', class: 'bg-red-500', label: 'Rojo' },
                { id: 'blue', class: 'bg-blue-500', label: 'Azul' },
                { id: 'green', class: 'bg-green-500', label: 'Verde' },
                { id: 'purple', class: 'bg-purple-500', label: 'Morado' },
                { id: 'yellow', class: 'bg-yellow-500', label: 'Amarillo' },
                { id: 'orange', class: 'bg-orange-500', label: 'Naranja' },
                { id: 'pink', class: 'bg-pink-500', label: 'Rosa' },
                { id: 'indigo', class: 'bg-indigo-500', label: '√çndigo' }
            ];

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const routineId = `custom_${Date.now()}`;
                    await db.collection('users').doc(user.uid).collection('routines').doc(routineId).set({
                        id: routineId,
                        name,
                        icon: selectedIcon,
                        color: selectedColor,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        exerciseIds: []
                    });
                    onSave();
                } catch (error) {
                    console.error("Error creating routine:", error);
                    alert("Error al crear la rutina");
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icon name="x" className="w-5 h-5" /></button>

                        <h3 className="text-xl font-black mb-2 text-gray-900">Nueva Rutina</h3>
                        <p className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-6">Crea tu rutina personalizada</p>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* Name Input */}
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nombre</label>
                                <input
                                    type="text"
                                    required
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Ej: Upper Body"
                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all font-bold"
                                />
                            </div>

                            {/* Icon Selector */}
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-3">Icono</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {icons.map(icon => (
                                        <button
                                            key={icon.id}
                                            type="button"
                                            onClick={() => setSelectedIcon(icon.id)}
                                            className={`p-3 rounded-xl border-2 transition-all ${selectedIcon === icon.id ? 'border-primary-500 bg-primary-50' : 'border-gray-200 hover:border-gray-300'}`}
                                        >
                                            <Icon name={icon.id} className={`w-6 h-6 mx-auto ${selectedIcon === icon.id ? 'text-primary-500' : 'text-gray-400'}`} />
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Color Selector */}
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-3">Color</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {colors.map(color => (
                                        <button
                                            key={color.id}
                                            type="button"
                                            onClick={() => setSelectedColor(color.id)}
                                            className={`h-12 rounded-xl ${color.class} transition-all ${selectedColor === color.id ? 'ring-4 ring-gray-300 scale-110' : 'hover:scale-105'}`}
                                        ></button>
                                    ))}
                                </div>
                            </div>

                            {/* Submit Button */}
                            <button
                                type="submit"
                                disabled={loading || !name}
                                className="w-full py-4 bg-primary-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-primary-500/30 hover:bg-primary-700 hover:shadow-primary-500/40 active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                            >
                                {loading ? <Icon name="loader-2" className="w-5 h-5 animate-spin" /> : 'Crear Rutina'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditExerciseModal = ({ exercise, onClose, onSave, onDelete }) => {
            const [name, setName] = React.useState(exercise.name);
            const [img, setImg] = React.useState(exercise.img);
            const [loading, setLoading] = React.useState(false);



            const handleSave = async () => {
                setLoading(true);
                await onSave(exercise.id, { name, img });
                setLoading(false);
                onClose();
            };

            const handleDelete = async () => {
                if (!window.confirm("¬øSeguro que quieres borrar este ejercicio? Se perder√° el historial de registros.")) return;
                setLoading(true);
                await onDelete(exercise.id);
                setLoading(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icon name="x" className="w-5 h-5" /></button>

                        <h3 className="text-xl font-black mb-6 text-gray-900">Editar Ejercicio</h3>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nombre</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500 font-bold"
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Imagen URL (Opcional)</label>
                                <input
                                    type="text"
                                    value={img}
                                    onChange={(e) => setImg(e.target.value)}
                                    placeholder="https://..."
                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500 text-xs"
                                />
                            </div>

                            {img && (
                                <div className="w-full h-32 bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center border border-gray-200">
                                    <img src={img} alt="Preview" className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                </div>
                            )}

                            <div className="flex gap-3 pt-2">
                                <button
                                    onClick={handleDelete}
                                    disabled={loading}
                                    className="flex-1 py-3 bg-red-50 text-red-500 rounded-xl font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2"
                                >
                                    <Icon name="trash-2" className="w-4 h-4" /> Borrar
                                </button>
                                <button
                                    onClick={handleSave}
                                    disabled={loading}
                                    className="flex-1 py-3 bg-primary-600 text-white rounded-xl font-bold shadow-lg shadow-primary-500/30 hover:bg-primary-700 transition-colors flex items-center justify-center gap-2"
                                >
                                    {loading ? <Icon name="loader-2" className="w-4 h-4 animate-spin" /> : 'Guardar'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const RoutineSelector = React.memo(({ activeRoutine, setActiveRoutine, customRoutines, onCreateRoutine, favorites = [] }) => {
            // Internal fetch removed to ensure sync with Dashboard

            const baseRoutines = [
                { id: 'push', name: 'Pecho / Tr√≠ceps', icon: 'zap', color: 'red', isBase: true },
                { id: 'pull', name: 'Espalda / B√≠ceps', icon: 'anchor', color: 'blue', isBase: true },
                { id: 'legs', name: 'Pierna', icon: 'move', color: 'green', isBase: true }
            ];

            const allRoutines = [...baseRoutines, ...customRoutines];

            // Sort: Favorites first, then base, then custom
            const sortedRoutines = React.useMemo(() => {
                return [...allRoutines].sort((a, b) => {
                    const safeFavs = Array.isArray(favorites) ? favorites : [];
                    const isFavA = safeFavs.includes(a.id);
                    const isFavB = safeFavs.includes(b.id);
                    if (isFavA && !isFavB) return -1;
                    if (!isFavA && isFavB) return 1;
                    return 0; // Keep original order otherwise
                });
            }, [allRoutines, favorites]);

            const getColorClasses = (color, isActive) => {
                const colorMap = {
                    red: isActive ? 'from-red-600 to-red-500 shadow-red-500/30' : 'border-red-200 hover:bg-red-50',
                    blue: isActive ? 'from-blue-600 to-blue-500 shadow-blue-500/30' : 'border-blue-200 hover:bg-blue-50',
                    green: isActive ? 'from-green-600 to-green-500 shadow-green-500/30' : 'border-green-200 hover:bg-green-50',
                    purple: isActive ? 'from-purple-600 to-purple-500 shadow-purple-500/30' : 'border-purple-200 hover:bg-purple-50',
                    yellow: isActive ? 'from-yellow-600 to-yellow-500 shadow-yellow-500/30' : 'border-yellow-200 hover:bg-yellow-50',
                    orange: isActive ? 'from-orange-600 to-orange-500 shadow-orange-500/30' : 'border-orange-200 hover:bg-orange-50',
                    pink: isActive ? 'from-pink-600 to-pink-500 shadow-pink-500/30' : 'border-pink-200 hover:bg-pink-50',
                    indigo: isActive ? 'from-indigo-600 to-indigo-500 shadow-indigo-500/30' : 'border-indigo-200 hover:bg-indigo-50'
                };
                return colorMap[color] || colorMap['red'];
            };

            return (
                <div className="flex gap-3 overflow-x-auto no-scrollbar mb-8 pb-2 px-1">
                    {sortedRoutines.map(routine => {
                        const isActive = activeRoutine === routine.id;
                        const isFav = favorites.includes(routine.id);
                        const colorClasses = getColorClasses(routine.color || 'red', isActive);
                        return (
                            <button
                                key={routine.id}
                                onClick={() => setActiveRoutine(routine.id)}
                                className={`flex-shrink-0 px-5 py-3 rounded-2xl text-sm font-bold transition-all duration-300 flex items-center gap-2 relative group ${isActive
                                    ? `bg-gradient-to-r ${colorClasses} text-white shadow-lg transform scale-[1.02] ring-2 ring-primary-100`
                                    : `bg-white text-gray-500 border ${colorClasses} hover:border-gray-200`
                                    }`}
                            >
                                {isFav && <Icon name="star" className={`w-3 h-3 absolute top-1 right-1 fill-yellow-400 text-yellow-500 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity`} />}
                                {routine.icon && <Icon name={routine.icon} className={`w-4 h-4 ${isActive ? 'text-white' : 'text-primary-500'}`} />}
                                {routine.name}
                            </button>
                        );
                    })}

                    {/* New Routine Button */}
                    <button
                        onClick={onCreateRoutine}
                        className="flex-shrink-0 px-5 py-3 rounded-2xl text-sm font-bold transition-all duration-300 flex items-center gap-2 bg-white text-primary-600 border-2 border-dashed border-primary-300 hover:bg-primary-50 hover:border-primary-400"
                    >
                        <Icon name="plus-circle" className="w-4 h-4" />
                        Nueva Rutina
                    </button>
                </div>
            );
        });


        // --- MAIN APP (Authenticated) ---


        // --- UTILS & HELPERS ---
        const calculateTDEE = (weight, height, age, gender, gymDays, walkingDays, walkingSteps, goal) => {
            // Mifflin-St Jeor Equation
            let bmr = (10 * weight) + (6.25 * height) - (5 * age);
            bmr += (gender === 'male') ? 5 : -161;

            // Base Multiplier (Sedentary baseline)
            let activityMult = 1.2;

            // Gym Days Adder
            // +0.05 per intense session (same as before)
            const gymFactor = parseFloat(gymDays) * 0.05;
            activityMult += gymFactor;

            // Walking Adder (NEAT)
            // Calculate weekly extra steps from walks
            // If walkingSteps is "low" (~3k) -> +0.02
            // "medium" (~7k) -> +0.05
            // "high" (~10k) -> +0.08
            // Averaged over the week

            const stepFactors = {
                '3000': 0.025,  // Short walk
                '7000': 0.06,   // Medium walk
                '10000': 0.1    // Long walk
            };

            const dailyWalkingFactor = stepFactors[walkingSteps] || 0;
            const totalWalkingAdd = dailyWalkingFactor * parseFloat(walkingDays);

            // Normalize to daily average boost
            // If I walk 7 days of 10k steps -> +0.7 total? No, too high.
            // Standard Active (1.55) vs Sedentary (1.2) is +0.35 diff
            // If 10k steps EVERY day, should approximate +0.35
            // So pure 10k daily steps factor should be ~0.35
            // My factor 0.1 * 7 = 0.7 -> too high.

            // Refined factors:
            // 7 days * x = 0.35 (Active) -> x = 0.05 per day of 10k steps
            // 7 days * x = 0.175 (Light) -> x = 0.025 per day of 5k steps

            const refinedFactors = {
                '3000': 0.015,
                '7000': 0.035,
                '10000': 0.05
            };

            activityMult += (refinedFactors[walkingSteps] || 0) * parseFloat(walkingDays);

            let tdee = bmr * activityMult;

            // Goal Adjustment
            if (goal === 'cut') tdee -= 500;
            if (goal === 'bulk') tdee += 300;

            return Math.round(tdee);
        };

        const UserProfileModal = ({ user, onClose, onSave, initialData }) => {
            const [formData, setFormData] = React.useState({
                nickname: initialData?.nickname || user.displayName || '',
                weight: initialData?.weight || '',
                height: initialData?.height || '',
                birthDate: initialData?.birthDate || '',
                gender: initialData?.gender || 'male',
                gymDays: initialData?.gymDays || '3',
                walkingDays: initialData?.walkingDays || '3',
                walkingSteps: initialData?.walkingSteps || '7000',
                goal: initialData?.goal || 'maintain'
            });
            const [loading, setLoading] = React.useState(false);
            const [nickError, setNickError] = React.useState('');



            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

            // Validate formats and uniqueness on save

            const calculateAge = (birthDateString) => {
                if (!birthDateString) return 25;
                const today = new Date();
                const birthDate = new Date(birthDateString);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setNickError('');

                try {
                    const cleanNick = formData.nickname.trim();
                    const oldNick = initialData?.nickname || user.displayName;
                    let nicknameChanged = false;

                    // 1. Validate Nickname Change
                    if (cleanNick !== oldNick) {
                        nicknameChanged = true;
                        if (cleanNick.length < 3) throw new Error("Nickname muy corto (min 3).");
                        if (/\s/.test(cleanNick)) throw new Error("El nickname no puede tener espacios.");

                        // Check availability
                        const lowNick = cleanNick.toLowerCase();
                        const checkDoc = await db.collection('usernames').doc(lowNick).get();

                        // If it exists, check if it's OURS (e.g. case change only) or someone else's
                        if (checkDoc.exists) {
                            if (checkDoc.data().uid !== user.uid) {
                                throw new Error("Este nickname ya est√° ocupado.");
                            }
                        }
                    }

                    const age = calculateAge(formData.birthDate);

                    const tdee = calculateTDEE(
                        parseFloat(formData.weight),
                        parseFloat(formData.height),
                        age,
                        formData.gender,
                        parseFloat(formData.gymDays),
                        parseFloat(formData.walkingDays),
                        formData.walkingSteps,
                        formData.goal
                    );

                    const profileData = {
                        ...formData, // includes nickname
                        nickname: cleanNick,
                        age,
                        tdee,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const batch = db.batch();

                    // Main Profile Update
                    const profileRef = db.collection('users').doc(user.uid).collection('profile').doc('main');
                    batch.set(profileRef, profileData);

                    // Handle Nickname Updates
                    if (nicknameChanged) {
                        const lowNick = cleanNick.toLowerCase();

                        // Reserve new
                        batch.set(db.collection('usernames').doc(lowNick), { uid: user.uid, original: cleanNick });

                        // Release old (if existed)
                        if (oldNick) {
                            const oldLow = oldNick.toLowerCase();
                            if (oldLow !== lowNick) {
                                batch.delete(db.collection('usernames').doc(oldLow));
                            }
                        }

                        // Update Public Profile
                        const safeEmail = user.email.replace(/\./g, '_');
                        batch.update(db.collection('users_public').doc(safeEmail), {
                            nickname: cleanNick,
                            name: cleanNick // Update name as well
                        });

                        // Update Firebase Auth Profile (async, non-blocking for batch)
                        user.updateProfile({ displayName: cleanNick });
                    } else if (!initialData) {
                        // Case: First save, nickname didn't change (still same as registered/default)
                        const safeEmail = user.email.replace(/\./g, '_');
                        // Just in case public profile needs refresh
                        batch.set(db.collection('users_public').doc(safeEmail), {
                            nickname: cleanNick,
                            name: cleanNick
                        }, { merge: true });
                    }

                    await batch.commit();
                    onSave(profileData);
                } catch (error) {
                    console.error(error);
                    if (error.message.includes("nickname") || error.message.includes("Nickname")) {
                        setNickError(error.message);
                    } else {
                        alert("Error al guardar perfil: " + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm animate-fade-in shadow-2xl h-[80vh] overflow-y-auto relative">
                        <button onClick={onClose} className="absolute top-4 right-4 w-10 h-10 bg-red-500 rounded-full hover:bg-red-600 transition-colors z-10 flex items-center justify-center shadow-lg">
                            <Icon name="x" className="w-5 h-5 text-white" />
                        </button>
                        <h3 className="text-xl font-black mb-1 text-gray-900">Tu Perfil</h3>
                        <p className="text-sm text-gray-500 mb-6">Necesitamos estos datos para calcular tus calor√≠as.</p>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* Nickname Input */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Nickname (√önico)</label>
                                <input
                                    name="nickname"
                                    type="text"
                                    value={formData.nickname}
                                    onChange={handleChange}
                                    className={`w-full p-3 bg-gray-50 rounded-xl font-bold border-2 ${nickError ? 'border-red-500 bg-red-50' : 'border-transparent focus:border-primary-500'}`}
                                    placeholder="Tu Apodo"
                                    required
                                />
                                {nickError && <p className="text-xs text-red-500 font-bold mt-1">{nickError}</p>}
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase">Peso (kg)</label>
                                    <input name="weight" type="number" step="0.1" value={formData.weight} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold" required />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase">Altura (cm)</label>
                                    <input name="height" type="number" value={formData.height} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold" required />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase">Nacimiento</label>
                                    <input name="birthDate" type="date" value={formData.birthDate} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm" required />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase">G√©nero</label>
                                    <select name="gender" value={formData.gender} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold">
                                        <option value="male">Hombre</option>
                                        <option value="female">Mujer</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">D√≠as Caminata / Semana</label>
                                <select name="walkingDays" value={formData.walkingDays} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm">
                                    <option value="0">0 d√≠as</option>
                                    <option value="1">1 d√≠a</option>
                                    <option value="2">2 d√≠as</option>
                                    <option value="3">3 d√≠as</option>
                                    <option value="4">4 d√≠as</option>
                                    <option value="5">5 d√≠as</option>
                                    <option value="6">6 d√≠as</option>
                                    <option value="7">7 d√≠as</option>
                                </select>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Pasos Aprox. por Caminata</label>
                                <select name="walkingSteps" value={formData.walkingSteps} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold text-sm">
                                    <option value="3000">Pocos (~3k pasos / 30 mins)</option>
                                    <option value="7000">Medio (~7k pasos / 1h)</option>
                                    <option value="10000">Muchos (+10k pasos / +1.5h)</option>
                                </select>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">D√≠as de Gym / Semana</label>
                                <select name="gymDays" value={formData.gymDays} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold">
                                    <option value="0">0 d√≠as</option>
                                    <option value="1">1 d√≠a</option>
                                    <option value="2">2 d√≠as</option>
                                    <option value="3">3 d√≠as</option>
                                    <option value="4">4 d√≠as</option>
                                    <option value="5">5 d√≠as</option>
                                    <option value="6">6 d√≠as</option>
                                    <option value="7">7 d√≠as</option>
                                </select>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Objetivo</label>
                                <select name="goal" value={formData.goal} onChange={handleChange} className="w-full p-3 bg-gray-50 rounded-xl font-bold">
                                    <option value="cut">Definir / Perder Grasa</option>
                                    <option value="maintain">Mantenimiento</option>
                                    <option value="bulk">Volumen / Ganar M√∫sculo</option>
                                </select>
                            </div>

                            <button type="submit" disabled={loading} className="w-full py-4 bg-primary-600 text-white rounded-xl font-bold shadow-lg shadow-primary-200 mt-4">
                                {loading ? 'Calculando...' : 'Guardar y Calcular'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const AddExerciseModal = ({ user, onClose, onSave }) => {
            const [name, setName] = React.useState('');
            const [muscle, setMuscle] = React.useState('');
            const [routine, setRoutine] = React.useState('push');
            const [loading, setLoading] = React.useState(false);
            const [customRoutines, setCustomRoutines] = React.useState([]);

            // Fetch custom routines
            React.useEffect(() => {
                if (!user) return;

                const unsubscribe = db.collection('users').doc(user.uid).collection('routines').onSnapshot(snapshot => {
                    const routines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCustomRoutines(routines);
                });

                return () => unsubscribe();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                await onSave({
                    name,
                    muscle,
                    routine,
                    img: './assets/push_illustration.png',
                    defaultSets: 3,
                    defaultWeight: 0,
                    defaultReps: 10
                });
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm animate-fade-in shadow-2xl">
                        <h3 className="text-lg font-bold mb-4 text-gray-900">Nuevo Ejercicio</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Nombre</label>
                                <input value={name} onChange={e => setName(e.target.value)} placeholder="Ej: Press Banca" className="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl font-medium outline-none focus:ring-2 focus:ring-primary-100" required />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">M√∫sculo</label>
                                <input value={muscle} onChange={e => setMuscle(e.target.value)} placeholder="Ej: Pecho" className="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl font-medium outline-none focus:ring-2 focus:ring-primary-100" required />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Rutina</label>
                                <select value={routine} onChange={e => setRoutine(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl font-medium outline-none focus:ring-2 focus:ring-primary-100">
                                    <optgroup label="Rutinas Base">
                                        <option value="push">Push (Pecho/Tr√≠ceps)</option>
                                        <option value="pull">Pull (Espalda/B√≠ceps)</option>
                                        <option value="legs">Legs (Pierna)</option>
                                    </optgroup>
                                    {customRoutines.length > 0 && (
                                        <optgroup label="Mis Rutinas">
                                            {customRoutines.map(r => (
                                                <option key={r.id} value={r.id}>{r.name}</option>
                                            ))}
                                        </optgroup>
                                    )}
                                </select>
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button type="button" onClick={onClose} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-xl transition-colors">Cancelar</button>
                                <button type="submit" disabled={loading} className="flex-1 py-3 bg-primary-600 text-white rounded-xl font-bold shadow-lg shadow-primary-200 hover:bg-primary-700 transition-colors">
                                    {loading ? 'Guardando...' : 'Guardar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ user }) => {
            const [currentDate, setCurrentDate] = React.useState(new Date());
            const [dailyData, setDailyData] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [selectedDate, setSelectedDate] = React.useState(null);

            React.useEffect(() => {
                const fetchHistory = async () => {
                    const snapshot = await db.collection('users').doc(user.uid).collection('daily').get();
                    const data = {};
                    let totalCals = 0;
                    let totalSteps = 0;
                    snapshot.forEach(doc => {
                        data[doc.id] = doc.data();
                        totalCals += (doc.data().burned || 0);
                        totalSteps += (doc.data().steps || 0);
                    });
                    setDailyData(data);
                    setLoading(false);
                };
                fetchHistory();
            }, [user]);



            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
                return { days, firstDay: adjustedFirstDay, year, month };
            };

            const { days, firstDay, year, month } = getDaysInMonth(currentDate);
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

            // Stats for current month view
            const currentMonthStats = React.useMemo(() => {
                let mBurned = 0;
                let mSteps = 0;
                let activeDays = 0;
                Object.keys(dailyData).forEach(key => {
                    if (key.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)) {
                        mBurned += (dailyData[key].burned || 0);
                        mSteps += (dailyData[key].steps || 0);
                        if (dailyData[key].burned > 0 || dailyData[key].steps > 0) activeDays++;
                    }
                });
                return { mBurned, mSteps, activeDays };
            }, [dailyData, year, month]);

            return (
                <div className="space-y-6 animate-slide-up pb-10">
                    {/* Monthly Summary Card */}
                    <div className="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-3xl p-6 text-white shadow-xl shadow-gray-200 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-8 bg-white/5 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <div className="flex justify-between items-start mb-8 relative z-10">
                            <div>
                                <h2 className="text-3xl font-black tracking-tight">{monthNames[month]}</h2>
                                <p className="text-stone-400 text-sm font-medium">{year}</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handlePrevMonth} className="p-2.5 bg-white/10 hover:bg-white/20 rounded-xl transition-colors backdrop-blur-md">
                                    <Icon name="chevron-left" className="w-5 h-5" />
                                </button>
                                <button onClick={handleNextMonth} className="p-2.5 bg-white/10 hover:bg-white/20 rounded-xl transition-colors backdrop-blur-md">
                                    <Icon name="chevron-right" className="w-5 h-5" />
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4 relative z-10">
                            <div className="bg-white/10 p-4 rounded-2xl backdrop-blur-sm border border-white/5 hover:bg-white/15 transition-colors">
                                <div className="text-[10px] text-gray-400 mb-1 font-bold uppercase tracking-wider flex items-center gap-1"><Icon name="check-circle" className="w-3 h-3" /> Activos</div>
                                <div className="text-2xl font-black">{currentMonthStats.activeDays} <span className="text-xs font-normal text-gray-400">d√≠as</span></div>
                            </div>
                            <div className="bg-white/10 p-4 rounded-2xl backdrop-blur-sm border border-white/5 hover:bg-white/15 transition-colors">
                                <div className="text-[10px] text-red-300 mb-1 font-bold uppercase tracking-wider flex items-center gap-1"><Icon name="flame" className="w-3 h-3" /> Kcal</div>
                                <div className="text-2xl font-black">{currentMonthStats.mBurned > 1000 ? (currentMonthStats.mBurned / 1000).toFixed(1) + 'k' : currentMonthStats.mBurned}</div>
                            </div>
                            <div className="bg-white/10 p-4 rounded-2xl backdrop-blur-sm border border-white/5 hover:bg-white/15 transition-colors">
                                <div className="text-[10px] text-blue-300 mb-1 font-bold uppercase tracking-wider flex items-center gap-1"><Icon name="footprints" className="w-3 h-3" /> Pasos</div>
                                <div className="text-2xl font-black">{(currentMonthStats.mSteps / 1000).toFixed(1)}k</div>
                            </div>
                        </div>
                    </div>

                    {/* Calendar Grid */}
                    <div className="glass-panel rounded-3xl p-6 relative overflow-hidden">
                        <div className="grid grid-cols-7 gap-2 mb-4 text-center">
                            {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(d => (
                                <div key={d} className="text-xs font-black text-stone-300 py-1">{d}</div>
                            ))}
                        </div>

                        <div className="grid grid-cols-7 gap-2">
                            {Array.from({ length: firstDay }).map((_, i) => (
                                <div key={`empty-${i}`} className="aspect-square"></div>
                            ))}

                            {Array.from({ length: days }).map((_, i) => {
                                const day = i + 1;
                                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const data = dailyData[dateStr];
                                const isToday = dateStr === new Date().toISOString().split('T')[0];
                                const hasActivity = data && (data.burned > 0 || data.steps > 0);

                                return (
                                    <div
                                        key={day}
                                        onClick={() => setSelectedDate(dateStr)}
                                        className={`
                                            aspect-square rounded-2xl flex flex-col items-center justify-center relative cursor-pointer group transition-all duration-300 hover:shadow-lg hover:-translate-y-1
                                            ${isToday
                                                ? 'bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg shadow-red-500/40 z-10 ring-2 ring-red-100'
                                                : hasActivity ? 'bg-white border border-stone-100 text-stone-700 hover:border-red-200' : 'bg-transparent hover:bg-stone-50 text-stone-400'}
                                        `}
                                    >
                                        <span className={`text-sm font-bold ${isToday ? 'text-white' : ''}`}>{day}</span>

                                        {/* Icons Indicators */}
                                        <div className="flex gap-0.5 mt-0.5 h-3 items-center">
                                            {data?.burned > 0 && (
                                                <Icon name="flame" className={`w-3 h-3 ${isToday ? 'text-white fill-white/30' : 'text-red-500 fill-red-100'}`} />
                                            )}
                                            {data?.steps > 0 && (
                                                <Icon name="footprints" className={`w-3 h-3 ${isToday ? 'text-blue-100 fill-blue-500/30' : 'text-blue-400 fill-blue-50'}`} />
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Selected Day Detail (Tooltip logic visual hint) */}
                    <div className="text-center text-xs text-stone-300 font-medium">
                        <p>Selecciona un d√≠a para ver detalles</p>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ user, onClose }) => {
            const [pin, setPin] = React.useState('');
            const [pendingUsers, setPendingUsers] = React.useState([]);
            const [activeUsers, setActiveUsers] = React.useState([]);
            const [activeTab, setActiveTab] = React.useState('pending'); // 'pending' | 'active'
            const [searchTerm, setSearchTerm] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [status, setStatus] = React.useState(null);

            // Load Pending Users
            React.useEffect(() => {
                const unsubscribe = db.collection('pending_users').onSnapshot(snapshot => {
                    setPendingUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);

            // Load Active Users
            React.useEffect(() => {
                const unsubscribe = db.collection('users_public').onSnapshot(snapshot => {
                    setActiveUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);



            const verifyPin = async (inputPin) => {
                if (!inputPin) return false;
                // Client-side Secure Hash Check (SHA-256 for "DaniCoche")
                const msgBuffer = new TextEncoder().encode(inputPin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                const validHash = "90cf92286aff0ec54631cc6c77647cdb022e8716ea736859e9f2710a7cedf5f1";
                return hashHex === validHash;
            };

            const handleVerify = async (action, userId) => {
                setLoading(true);
                setStatus(null);
                try {
                    if (await verifyPin(pin)) {
                        if (action === 'approve' || action === 'reject') {
                            await db.collection('pending_users').doc(userId).delete();
                            setStatus({ type: 'success', message: `Usuario ${action === 'approve' ? 'aprobado' : 'rechazado'}` });
                        }
                    } else {
                        setStatus({ type: 'error', message: 'PIN incorrecto' });
                    }
                } catch (error) {
                    setStatus({ type: 'error', message: error.message });
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteUser = async (targetUser) => {
                if (!window.confirm(`¬øSeguro que quieres borrar a ${targetUser.name || targetUser.email}? Esta acci√≥n no se puede deshacer.`)) return;

                setLoading(true);
                setStatus(null);
                try {
                    if (await verifyPin(pin)) {
                        setStatus({ type: 'success', message: 'Limpiando datos...' });

                        // --- DEEP CLEAN START ---
                        const subcollections = ['profile', 'stats', 'logs', 'settings', 'daily', 'inbox', 'friends', 'routines'];

                        for (const subCol of subcollections) {
                            const ref = db.collection('users').doc(targetUser.uid).collection(subCol);
                            const snapshot = await ref.get();

                            if (!snapshot.empty) {
                                // Delete in chunks of 400 to be safe
                                const chunkParams = 400;
                                let paramsCount = 0;
                                let batch = db.batch();

                                for (const doc of snapshot.docs) {
                                    batch.delete(ref.doc(doc.id));
                                    paramsCount++;

                                    if (paramsCount >= chunkParams) {
                                        await batch.commit();
                                        batch = db.batch();
                                        paramsCount = 0;
                                    }
                                }
                                if (paramsCount > 0) await batch.commit();
                            }
                        }
                        // --- DEEP CLEAN END ---

                        const batch = db.batch();

                        // 1. Delete Public Profile
                        batch.delete(db.collection('users_public').doc(targetUser.id));

                        // 2. Delete Username Reservation (if exists)
                        if (targetUser.nickname) {
                            batch.delete(db.collection('usernames').doc(targetUser.nickname.toLowerCase()));
                        }

                        // 3. Delete Main Profile (Redundant given deep clean, but keeps atomic guarantee)
                        batch.delete(db.collection('users').doc(targetUser.uid).collection('profile').doc('main'));

                        // 3.5 Delete User Document Itself (The "Ghost" Parent)
                        batch.delete(db.collection('users').doc(targetUser.uid));

                        // 4. Cleanup Pending
                        batch.delete(db.collection('pending_users').doc(targetUser.uid));

                        await batch.commit();
                        setStatus({ type: 'success', message: 'Usuario y sus datos eliminados correctamente' });
                    } else {
                        setStatus({ type: 'error', message: 'PIN incorrecto' });
                    }
                } catch (error) {
                    console.error(error);
                    setStatus({ type: 'error', message: 'Error al eliminar usuario' });
                } finally {
                    setLoading(false);
                }
            };

            // Filter Active Users
            const filteredActive = activeUsers.filter(u => {
                const term = searchTerm.toLowerCase();
                return (u.name && u.name.toLowerCase().includes(term)) ||
                    (u.email && u.email.toLowerCase().includes(term)) ||
                    (u.nickname && u.nickname.toLowerCase().includes(term)) ||
                    (u.uid && u.uid.includes(term));
            });

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icon name="x" className="w-5 h-5" /></button>

                        <div className="flex items-center gap-3 mb-6">
                            <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <Icon name="shield-check" className="w-6 h-6 text-purple-600" />
                            </div>
                            <div>
                                <h3 className="text-xl font-black text-gray-900">Panel Admin</h3>
                                <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Gesti√≥n Total</p>
                            </div>
                        </div>

                        {/* PIN Input */}
                        <div className="mb-4 bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">PIN Maestro</label>
                            <input
                                type="password"
                                value={pin}
                                onChange={e => setPin(e.target.value)}
                                placeholder="Introduce PIN..."
                                className="w-full px-4 py-2 bg-white rounded-lg border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-500 font-black tracking-widest"
                            />
                        </div>

                        {status && (
                            <div className={`mb-4 p-3 rounded-xl text-sm font-bold flex items-center gap-2 ${status.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                <Icon name={status.type === 'success' ? 'check-circle' : 'alert-circle'} className="w-4 h-4" />
                                {status.message}
                            </div>
                        )}

                        {/* Tabs */}
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => setActiveTab('pending')}
                                className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'pending' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}
                            >
                                Pendientes ({pendingUsers.length})
                            </button>
                            <button
                                onClick={() => setActiveTab('active')}
                                className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'active' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}
                            >
                                Activos ({activeUsers.length})
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            {activeTab === 'pending' ? (
                                <div className="space-y-2">
                                    {pendingUsers.length === 0 ? <p className="text-center text-gray-400 text-sm py-4">No hay solicitudes pendientes.</p> :
                                        pendingUsers.map(u => (
                                            <div key={u.id} className="bg-gray-50 p-3 rounded-xl flex items-center justify-between border border-gray-100">
                                                <div className="overflow-hidden">
                                                    <p className="font-bold text-gray-900 text-sm truncate">{u.email}</p>
                                                    <p className="text-xs text-gray-400 font-mono truncate">{u.uid}</p>
                                                    {u.nickname && <p className="text-xs text-purple-500 font-bold">@{u.nickname}</p>}
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleVerify('approve', u.id)} className="p-2 bg-green-100 text-green-600 rounded-lg"><Icon name="check" className="w-4 h-4" /></button>
                                                    <button onClick={() => handleVerify('reject', u.id)} className="p-2 bg-red-100 text-red-600 rounded-lg"><Icon name="x" className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                        ))}
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    <input
                                        type="text"
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        placeholder="Buscar por email, nombre, ID..."
                                        className="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mb-2 sticky top-0"
                                    />
                                    {filteredActive.map(u => (
                                        <div key={u.id} className="bg-white border border-gray-100 p-3 rounded-xl shadow-sm">
                                            <div className="flex items-center gap-3 mb-2">
                                                <img src={u.photo} className="w-8 h-8 rounded-full bg-gray-100" />
                                                <div className="overflow-hidden">
                                                    <h4 className="font-bold text-gray-900 text-sm truncate">{u.name || 'Usuario'}</h4>
                                                    <p className="text-xs text-gray-400 truncate">{u.email}</p>
                                                    {u.nickname && <p className="text-xs text-purple-500 font-bold">@{u.nickname}</p>}
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center border-t border-gray-50 pt-2">
                                                <span className="text-[10px] text-gray-400 font-mono tracking-tighter truncate max-w-[100px]">{u.uid}</span>
                                                <button
                                                    onClick={() => handleDeleteUser(u)}
                                                    className="px-3 py-1 bg-red-50 text-red-500 text-xs font-bold rounded-lg hover:bg-red-100 transition-colors flex items-center gap-1"
                                                >
                                                    <Icon name="trash-2" className="w-3 h-3" /> Borrar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };


        // Social Panel Component
        const SocialPanel = ({ user, userProfile }) => {
            const [activeTab, setActiveTab] = React.useState('friends');
            const [friends, setFriends] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [searchResults, setSearchResults] = React.useState([]);
            const [loading, setLoading] = React.useState(false);

            // Fetch Friends
            React.useEffect(() => {
                const unsubscribe = db.collection('users').doc(user.uid).collection('friends')
                    .orderBy('addedAt', 'desc')
                    .onSnapshot(snapshot => {
                        const friendsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setFriends(friendsList);
                    });
                return () => unsubscribe();
            }, [user.uid]);

            const handleSearch = async (e) => {
                e.preventDefault();
                if (!searchTerm || searchTerm.length < 3) return;

                setLoading(true);
                try {
                    let foundDoc = null;

                    if (searchTerm.includes('@')) {
                        // Email Search
                        const safeEmail = searchTerm.toLowerCase().replace(/\./g, '_');
                        const doc = await db.collection('users_public').doc(safeEmail).get();
                        if (doc.exists) foundDoc = { id: doc.id, ...doc.data() };
                    } else {
                        // Nickname Search
                        const lowNick = searchTerm.trim().toLowerCase();
                        // 1. Check usernames registry
                        const nickDoc = await db.collection('usernames').doc(lowNick).get();

                        if (nickDoc.exists) {
                            const { uid } = nickDoc.data();
                            // 2. Lookup Public Profile by UID
                            const querySnap = await db.collection('users_public').where('uid', '==', uid).get();
                            if (!querySnap.empty) {
                                const doc = querySnap.docs[0];
                                foundDoc = { id: doc.id, ...doc.data() };
                            }
                        }
                    }

                    if (foundDoc) {
                        setSearchResults([foundDoc]);
                    } else {
                        setSearchResults([]);
                    }
                } catch (error) {
                    console.error("Error searching:", error);
                }
                setLoading(false);
            };

            const addFriend = async (friendData) => {
                try {
                    // Add to my friends
                    await db.collection('users').doc(user.uid).collection('friends').doc(friendData.uid).set({
                        uid: friendData.uid,
                        name: friendData.name || friendData.email.split('@')[0],
                        email: friendData.email,
                        photo: friendData.photo,
                        lastWorkout: friendData.lastWorkout || null,
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Add me to their friends (Reciprocal)
                    await db.collection('users').doc(friendData.uid).collection('friends').doc(user.uid).set({
                        uid: user.uid,
                        name: userProfile?.name || user.email.split('@')[0],
                        email: user.email,
                        photo: `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`,
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert("¬°Amigo a√±adido!");
                    setSearchTerm('');
                    setSearchResults([]);
                    setActiveTab('friends');
                } catch (error) {
                    console.error("Error adding friend:", error);
                    alert("Error al a√±adir amigo");
                }
            };

            const sendNudge = async (friendId, friendName) => {
                try {
                    await db.collection('users').doc(friendId).collection('inbox').add({
                        type: 'nudge',
                        fromUid: user.uid,
                        fromName: userProfile?.name || user.email.split('@')[0],
                        message: "¬°A entrenar! üí™",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false
                    });
                    alert(`¬°Has gritado a ${friendName}!`);
                } catch (error) {
                    console.error("Error sending nudge:", error);
                }
            };

            return (
                <div className="pb-20">
                    <div className="flex gap-2 mb-6 bg-white p-1 rounded-xl border border-gray-100 shadow-sm">
                        <button
                            onClick={() => setActiveTab('friends')}
                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'friends' ? 'bg-primary-50 text-primary-600' : 'text-gray-400 hover:bg-gray-50'}`}
                        >
                            Mis Amigos
                        </button>
                        <button
                            onClick={() => setActiveTab('add')}
                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'add' ? 'bg-primary-50 text-primary-600' : 'text-gray-400 hover:bg-gray-50'}`}
                        >
                            A√±adir
                        </button>
                    </div>

                    {activeTab === 'friends' && (
                        <div className="space-y-3">
                            {friends.length === 0 ? (
                                <div className="text-center py-10 text-gray-400">
                                    <Icon name="users" className="w-12 h-12 mx-auto mb-3 opacity-20" />
                                    <p>No tienes amigos a√∫n.</p>
                                    <button onClick={() => setActiveTab('add')} className="mt-4 text-primary-600 font-bold text-sm">Buscar amigos</button>
                                </div>
                            ) : (
                                friends.map(friend => (
                                    <div key={friend.uid} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <img src={friend.photo} className="w-10 h-10 rounded-full bg-gray-100" />
                                            <div>
                                                <h4 className="font-bold text-gray-900">{friend.name}</h4>
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-green-500 font-medium flex items-center gap-1">
                                                        <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Online
                                                    </span>
                                                    {friend.lastWorkout ? (
                                                        <span className="text-[10px] text-gray-400 mt-0.5">
                                                            √öltimo: {new Date(friend.lastWorkout).toLocaleDateString()}
                                                        </span>
                                                    ) : (
                                                        <span className="text-[10px] text-gray-300 mt-0.5">Sin actividad reciente</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => sendNudge(friend.uid, friend.name)}
                                            className="w-10 h-10 rounded-full bg-primary-50 text-primary-600 flex items-center justify-center hover:bg-primary-100 transition-colors"
                                        >
                                            <Icon name="megaphone" className="w-5 h-5" />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {activeTab === 'add' && (
                        <div className="space-y-6">
                            <form onSubmit={handleSearch} className="relative">
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    placeholder="Email o Nickname..."
                                    className="w-full pl-4 pr-12 py-3 bg-white border border-gray-200 rounded-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                                <button type="submit" className="absolute right-2 top-2 p-1.5 bg-primary-600 text-white rounded-lg">
                                    <Icon name="search" className="w-4 h-4" />
                                </button>
                            </form>

                            <div className="space-y-2">
                                {loading && <div className="text-center p-4"><Icon name="loader-2" className="w-6 h-6 animate-spin mx-auto text-primary-500" /></div>}

                                {searchResults.map(result => (
                                    <div key={result.uid} className="bg-white p-4 rounded-2xl shadow-lg border border-primary-100 flex items-center justify-between animate-fade-in">
                                        <div className="flex items-center gap-3">
                                            <img src={result.photo} className="w-12 h-12 rounded-full bg-gray-100" />
                                            <div>
                                                <h4 className="font-bold text-gray-900">{result.name}</h4>
                                                <p className="text-xs text-gray-400">{result.email}</p>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => addFriend(result)}
                                            className="bg-black text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-800"
                                        >
                                            A√±adir
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [activeTab, setActiveTab] = React.useState('home');
            const [activeRoutine, setActiveRoutine] = React.useState('push');
            const [showAddModal, setShowAddModal] = React.useState(false);
            const [showUserMenu, setShowUserMenu] = React.useState(false);
            const [showAdminPanel, setShowAdminPanel] = React.useState(false);
            const [editExercise, setEditExercise] = React.useState(null);
            const [favoriteRoutines, setFavoriteRoutines] = React.useState([]);

            // Load Favorites
            React.useEffect(() => {
                const unsubscribe = db.collection('users').doc(user.uid).collection('profile').doc('settings')
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            setFavoriteRoutines(Array.isArray(data?.favorites) ? data.favorites : []);
                        } else {
                            setFavoriteRoutines([]);
                        }
                    });
                return () => unsubscribe();
            }, [user.uid]);


            // Exercise Management Handlers
            const handleEditExercise = (exercise) => {
                setEditExercise(exercise);
            };

            const handleToggleFavorite = async (routineId) => {
                const safeFavs = Array.isArray(favoriteRoutines) ? favoriteRoutines : [];
                const isFav = safeFavs.includes(routineId);
                let newFavs;
                if (isFav) {
                    newFavs = safeFavs.filter(id => id !== routineId);
                } else {
                    newFavs = [...safeFavs, routineId];
                }

                await db.collection('users').doc(user.uid).collection('profile').doc('settings').set({
                    favorites: newFavs
                }, { merge: true });
            };

            const handleDeleteRoutine = async (routineId, routineName) => {
                if (!window.confirm(`¬øBorrar rutina "${routineName}"? Se perder√° para siempre.`)) return;

                try {
                    await db.collection('users').doc(user.uid).collection('routines').doc(routineId).delete();
                    setActiveRoutine('push'); // Reset to default
                    alert("Rutina eliminada");
                } catch (e) {
                    console.error(e);
                    alert("Error al borrar rutina");
                }
            };

            const handleUpdateExercise = async (id, data) => {
                try {
                    await db.collection('exercises').doc(id).update(data);
                    // The onSnapshot listener will automatically update the UI
                } catch (error) {
                    console.error("Error updating exercise:", error);
                    alert("Error al actualizar el ejercicio");
                }
            };

            const handleDeleteExercise = async (id) => {
                try {
                    await db.collection('exercises').doc(id).delete();
                    // The onSnapshot listener will automatically update the UI
                    // Note: We are keeping the logs for stats history
                } catch (error) {
                    console.error("Error deleting exercise:", error);
                    alert("Error al borrar el ejercicio");
                }
            };

            // UI State
            const [searchTerm, setSearchTerm] = React.useState('');
            const [isOnline, setIsOnline] = React.useState(navigator.onLine);

            React.useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Timer State
            const [timer, setTimer] = React.useState({ isActive: false, time: 90 });

            // Pro Tools State
            const [plateCalc, setPlateCalc] = React.useState({ isOpen: false, weight: 60 });
            const [chartModal, setChartModal] = React.useState({ isOpen: false, exerciseId: null, name: '' });

            // Gamification State
            const [userStats, setUserStats] = React.useState({ points: 0, level: 0, badges: [], streakDays: 0, totalWorkouts: 0, totalPRs: 0, lastWorkoutDate: null });
            const [showBadgesModal, setShowBadgesModal] = React.useState(false);
            const [pointsAnimation, setPointsAnimation] = React.useState({ show: false, amount: 0, reason: '' });

            // --- FIRESTORE STATE ---
            const [exercises, setExercises] = React.useState([]);
            const [logs, setLogs] = React.useState({});
            const [userProfile, setUserProfile] = React.useState(null);
            const [showProfileModal, setShowProfileModal] = React.useState(false);
            const [loading, setLoading] = React.useState(true);
            const [darkMode, setDarkMode] = React.useState(false);
            const [showCreateRoutineModal, setShowCreateRoutineModal] = React.useState(false);

            const [customRoutines, setCustomRoutines] = React.useState([]);

            const [notifications, setNotifications] = React.useState([]);

            // Fetch Data
            React.useEffect(() => {
                // Check and Create Public Profile (Self-healing for Social Features)
                const checkPublicProfile = async () => {
                    if (!user || !user.email) return;
                    const safeEmail = user.email.replace(/\./g, '_');
                    const pubDoc = await db.collection('users_public').doc(safeEmail).get();
                    if (!pubDoc.exists) {
                        // Auto-creating public profile
                        await db.collection('users_public').doc(safeEmail).set({
                            uid: user.uid,
                            email: user.email,
                            name: user.email.split('@')[0],
                            level: 0,
                            photo: `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`
                        });
                    }
                };
                checkPublicProfile();

                // ... existing listeners ...
                const unsubExercises = db.collection('exercises').onSnapshot(snapshot => {
                    const exData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExercises(exData);
                    setLoading(false);
                });

                // ... (Keep existing listeners 2, 3, 4, 5, 6) ...
                const unsubLogs = db.collection('users').doc(user.uid).collection('logs').onSnapshot(snapshot => {
                    const logData = {};
                    snapshot.docs.forEach(doc => {
                        logData[doc.id] = doc.data();
                    });
                    setLogs(logData);
                });

                const unsubProfile = db.collection('users').doc(user.uid).collection('profile').doc('main').onSnapshot(doc => {
                    if (doc.exists) {
                        setUserProfile(doc.data());
                        setShowProfileModal(false);
                    } else {
                        if (!loading) setShowProfileModal(true);
                    }
                });

                const unsubStats = db.collection('users').doc(user.uid).collection('stats').doc('gamification').onSnapshot(doc => {
                    if (doc.exists) {
                        setUserStats(doc.data());
                    } else {
                        db.collection('users').doc(user.uid).collection('stats').doc('gamification').set({
                            points: 0, level: 0, badges: [], streakDays: 0, totalWorkouts: 0, totalPRs: 0, lastWorkoutDate: null
                        });
                    }
                });

                const unsubDarkMode = db.collection('users').doc(user.uid).collection('settings').doc('preferences').onSnapshot(doc => {
                    if (doc.exists && doc.data().darkMode !== undefined) {
                        const isDark = doc.data().darkMode;
                        setDarkMode(isDark);
                        if (isDark) { document.body.classList.add('dark'); } else { document.body.classList.remove('dark'); }
                    }
                });

                const unsubRoutines = db.collection('users').doc(user.uid).collection('routines').onSnapshot(snapshot => {
                    const routines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCustomRoutines(routines);
                });

                // 7. Listen to Inbox (Social Notifications)
                const unsubInbox = db.collection('users').doc(user.uid).collection('inbox')
                    .where('read', '==', false)
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .onSnapshot(snapshot => {
                        const notifs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setNotifications(notifs);

                        // Auto-show toast for new messages
                        if (notifs.length > 0) {
                            // Logic to avoid spamming could be here, but simple for now
                        }
                    }, err => console.log("Inbox error (requires index likely):", err));

                return () => {
                    unsubExercises();
                    unsubLogs();
                    unsubProfile();
                    unsubStats();
                    unsubDarkMode();
                    unsubRoutines();
                    unsubInbox();
                };
            }, [user.uid]);

            // ... (keep existing effects) ...

            // Function to dismiss notification (mark as read)
            const dismissNotification = async (notifId) => {
                await db.collection('users').doc(user.uid).collection('inbox').doc(notifId).update({ read: true });
            };

            // ... (keep rest of data transformation) ...



            // Ensure modal shows if no profile found after initial load
            React.useEffect(() => {
                if (!loading && !userProfile && exercises.length > 0) {
                    setShowProfileModal(true);
                }
            }, [loading, userProfile, exercises]);

            // --- DATA TRANSFORMATION (Firestore -> App UI) ---
            // Group exercises by routine
            const routinesData = React.useMemo(() => {
                const grouped = {
                    push: { name: "Pecho / Tr√≠ceps", stats: [7500, 7800, 8100, 8500], exercises: [] },
                    pull: { name: "Espalda / B√≠ceps", stats: [6200, 6800, 6500, 7200], exercises: [] },
                    legs: { name: "Pierna Completa", stats: [8000, 8200, 9000, 9500], exercises: [] }
                };

                // Add Custom Routines to grouped object
                customRoutines.forEach(r => {
                    grouped[r.id] = {
                        name: r.name,
                        // Mock stats for chart for now, or calculate real volume history if possible
                        stats: [0, 0, 0, 0],
                        exercises: []
                    };
                });

                exercises.forEach(ex => {
                    if (grouped[ex.routine]) {
                        // Merge exercise definition with user logs
                        const userLog = logs[ex.id] || { sets: [] };
                        // If no sets logged, provide default empty sets based on exercise default
                        const sets = userLog.sets.length > 0
                            ? userLog.sets
                            : Array.from({ length: ex.defaultSets || 3 }, (_, i) => ({
                                id: Date.now() + i,
                                weight: ex.defaultWeight || 0,
                                reps: ex.defaultReps || 0,
                                isCompleted: false
                            }));



                        // Calculate Best 1RM for this exercise based on logs
                        const max1RM = sets.reduce((max, s) => {
                            const rm = s.weight * (1 + s.reps / 30);
                            return rm > max ? rm : max;
                        }, 0);

                        grouped[ex.routine].exercises.push({
                            ...ex,
                            sets: sets,
                            max1RM: Math.round(max1RM)
                        });
                    }
                });

                return grouped;
            }, [exercises, logs, customRoutines]);

            // --- ACTIONS ---

            // Gamification Functions
            const awardPoints = async (amount, reason) => {
                const newPoints = userStats.points + amount;
                const oldLevel = getCurrentLevel(userStats.points);
                const newLevel = getCurrentLevel(newPoints);

                // Show points animation
                setPointsAnimation({ show: true, amount, reason });

                // Check for new badges
                const newBadges = [...userStats.badges];
                const updatedStats = { ...userStats, points: newPoints };

                BADGES.forEach(badge => {
                    if (!newBadges.includes(badge.id) && badge.criteria(updatedStats)) {
                        newBadges.push(badge.id);
                        // Show confetti for new badge
                        confetti({
                            particleCount: 150,
                            spread: 100,
                            origin: { y: 0.6 },
                            colors: ['#FFD700', '#FFA500', '#FF6347']
                        });
                    }
                });

                // Update Firestore
                try {
                    await db.collection('users').doc(user.uid).collection('stats').doc('gamification').update({
                        points: newPoints,
                        level: newLevel,
                        badges: newBadges
                    });

                    // Level up celebration
                    if (newLevel > oldLevel) {
                        confetti({
                            particleCount: 200,
                            spread: 120,
                            origin: { y: 0.5 },
                            colors: ['#9333EA', '#EC4899', '#F59E0B']
                        });
                    }
                } catch (e) {
                    console.error("Error updating stats:", e);
                }
            };

            const updateStreak = async () => {
                const today = new Date().toDateString();
                const lastDate = userStats.lastWorkoutDate ? new Date(userStats.lastWorkoutDate).toDateString() : null;

                if (lastDate === today) return; // Already worked out today

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                let newStreak = userStats.streakDays;
                if (lastDate === yesterdayStr) {
                    newStreak += 1; // Continue streak
                } else if (lastDate !== today) {
                    newStreak = 1; // Reset streak
                }

                try {
                    await db.collection('users').doc(user.uid).collection('stats').doc('gamification').update({
                        streakDays: newStreak,
                        lastWorkoutDate: new Date().toISOString(),
                        totalWorkouts: firebase.firestore.FieldValue.increment(1)
                    });

                    // Sync to Public Profile (Social)
                    try {
                        const safeEmail = user.email.replace(/\./g, '_');
                        await db.collection('users_public').doc(safeEmail).set({
                            lastWorkout: new Date().toISOString()
                        }, { merge: true });
                    } catch (err) {
                        console.log("Social sync error (non-critical):", err);
                    }

                    // Award streak points
                    const streakBonus = newStreak >= 7 ? 15 : 10;
                    awardPoints(streakBonus, `D√≠a ${newStreak} consecutivo`);
                } catch (e) {
                    console.error("Error updating streak:", e);
                }
            };

            const calculateSetCalories = (weight, reps, setType, userWeight = 75) => {
                const w = parseFloat(weight) || 0;
                const r = parseFloat(reps) || 0;
                const uw = parseFloat(userWeight) || 75;

                if (w < 0) return 0;

                // 1. Intensity Component (Square Law): Favors weight significantly over reps.
                // Formula: Weight^2 * Reps * Constant
                // Example: 90kg^2 * 7 = 56,700 * 0.00007 = 3.9 kcal (+ ~2 kcal metabolic = ~6 kcal).
                // Example: 70kg^2 * 10 = 49,000 * 0.00007 = 3.4 kcal (+ ~2.5 kcal metabolic = ~6 kcal).
                // Target Range: 4-8 kcal per set max.
                const intensityConstant = 0.00007;
                const workCalories = Math.pow(w, 2) * r * intensityConstant;

                // 2. Metabolic Component (Time & Ef√≠ciency)
                // Assumes moderate pace (2.5s/rep).
                const timeMinutes = (r * 2.5) / 60;

                // METs based on Type & Ratio
                let metValue = 3; // Baseline (Warmup/Rest)
                if (setType === 'working') metValue = 6;
                if (setType === 'approach') metValue = 4.5;

                // Heavy Bonus: If lifting > 80% bodyweight, increase metabolic demand
                if ((w / uw) > 0.8) metValue *= 1.25;

                const metCalories = metValue * (uw / 75) * timeMinutes;

                // Total: Sum of Mechanical Work + Metabolic Cost
                const total = workCalories + metCalories;

                // Type Multiplier (User intent)
                const typeMult = setType === 'warmup' ? 0.5 : (setType === 'approach' ? 0.8 : 1.0);

                const final = parseFloat((Math.max(r > 0 ? 0.1 : 0, total * typeMult)).toFixed(2));
                return isNaN(final) ? 0 : final;
            };

            // Update daily calories in Firestore
            const addCaloriesToday = async (calories) => {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                try {
                    const docRef = db.collection('users').doc(user.uid).collection('daily').doc(today);
                    docRef.set({
                        burned: firebase.firestore.FieldValue.increment(calories),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (e) {
                    console.error("Error updating burned calories:", e);
                }
            };

            const saveLog = async (exerciseId, newSets) => {
                try {
                    await db.collection('users').doc(user.uid).collection('logs').doc(exerciseId).set({
                        sets: newSets,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (e) {
                    console.error("Error saving log:", e);
                }
            };

            const handleUpdateSet = (exerciseId, setId, field, value) => {
                // Sanitize Inputs
                if ((field === 'weight' || field === 'reps') && value !== '') {
                    if (parseFloat(value) < 0) value = 0;
                }

                const routine = routinesData[activeRoutine];
                const exercise = routine.exercises.find(e => e.id === exerciseId);
                if (!exercise) return;

                const newSets = exercise.sets.map(s => {
                    if (s.id === setId) {
                        // PR CHECK & TIMER TRIGGER & CALORIE logic
                        if (field === 'isCompleted') {
                            // Calculate calories
                            const cals = calculateSetCalories(
                                s.weight,
                                s.reps,
                                s.type || 'working',
                                userProfile?.weight || 75
                            );

                            if (value === true) {
                                // 1. ADD calories
                                addCaloriesToday(cals);

                                // 2. Start Timer
                                setTimer({ isActive: true, time: 90 });

                                // 3. Check PR
                                // Calculate 1RM of COMPLETED set
                                const epley1RM = Math.round(s.weight * (1 + s.reps / 30));
                                if (epley1RM > (exercise.max1RM || 0)) {
                                    confetti({
                                        particleCount: 100,
                                        spread: 70,
                                        origin: { y: 0.6 },
                                        colors: ['#E63946', '#FFFFFF']
                                    });

                                    awardPoints(50, '¬°Nuevo PR! üí™');

                                    db.collection('users').doc(user.uid).collection('stats').doc('gamification').update({
                                        totalPRs: firebase.firestore.FieldValue.increment(1)
                                    });
                                }

                                // 4. Update streak 
                                updateStreak();
                            } else {
                                // REMOVE calories if unchecked
                                addCaloriesToday(-cals);
                            }
                        }
                        return { ...s, [field]: value };
                    }
                    return s;
                });
                saveLog(exerciseId, newSets);
            };

            const handleAddSet = (exerciseId) => {
                const routine = routinesData[activeRoutine];
                const exercise = routine.exercises.find(e => e.id === exerciseId);
                if (!exercise) return;

                const lastSet = exercise.sets[exercise.sets.length - 1] || { weight: 0, reps: 0 };
                const newSet = { id: Date.now(), weight: lastSet.weight, reps: lastSet.reps, isCompleted: false };
                saveLog(exerciseId, [...exercise.sets, newSet]);
            };

            const handleRemoveSet = (exerciseId) => {
                const routine = routinesData[activeRoutine];
                const exercise = routine.exercises.find(e => e.id === exerciseId);
                if (!exercise) return;

                const newSets = exercise.sets.slice(0, -1);
                saveLog(exerciseId, newSets);
            };

            const handleAddExercise = async (exerciseData) => {
                try {
                    await db.collection('exercises').add(exerciseData);
                    setShowAddModal(false);
                } catch (e) {
                    console.error("Error adding exercise:", e);
                    alert("Error al guardar el ejercicio");
                }
            };

            const handleSaveProfile = (data) => {
                setUserProfile(data); // Optimistic update
                setShowProfileModal(false);
            };

            const toggleDarkMode = async () => {
                const newDarkMode = !darkMode;
                setDarkMode(newDarkMode);

                // Apply immediately for better UX
                if (newDarkMode) {
                    document.body.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                }

                // Persist to Firestore
                try {
                    await db.collection('users').doc(user.uid).collection('settings').doc('preferences').set({
                        darkMode: newDarkMode,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error("Error saving dark mode preference:", error);
                }
            };

            // SEED DATABASE FUNCTION (Run once)
            const seedDatabase = async () => {
                if (!window.confirm("¬øSeguro que quieres BORRAR TODO y restaurar los ejercicios base? Esta acci√≥n eliminar√° los ejercicios antiguos.")) return;
                try {
                    // 1. Delete all existing exercises
                    const snapshot = await db.collection('exercises').get();
                    const batchDelete = db.batch();
                    snapshot.docs.forEach(doc => {
                        batchDelete.delete(doc.ref);
                    });
                    await batchDelete.commit();

                    // 2. Add new exercises
                    const batch = db.batch();
                    const initialExercises = [
                        // PUSH (Pecho/Tr√≠ceps/Hombro) - IMG: ./assets/push_illustration.png
                        { id: 'push_1', name: 'Press de Banca', muscle: 'Pecho', routine: 'push', img: './assets/push_illustration.png', defaultSets: 4, defaultWeight: 60, defaultReps: 10 },
                        { id: 'push_2', name: 'Press Inclinado (Mancuernas)', muscle: 'Pecho', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 24, defaultReps: 12 },
                        { id: 'push_3', name: 'Aperturas en M√°quina', muscle: 'Pecho', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 40, defaultReps: 15 },
                        { id: 'push_4', name: 'Press Militar', muscle: 'Hombro', routine: 'push', img: './assets/push_illustration.png', defaultSets: 4, defaultWeight: 30, defaultReps: 10 },
                        { id: 'push_5', name: 'Elevaciones Laterales', muscle: 'Hombro', routine: 'push', img: './assets/push_illustration.png', defaultSets: 4, defaultWeight: 10, defaultReps: 15 },
                        { id: 'push_6', name: 'Fondos (Dips)', muscle: 'Pecho/Tr√≠ceps', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 0, defaultReps: 10 },
                        { id: 'push_7', name: 'Press Franc√©s', muscle: 'Tr√≠ceps', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 20, defaultReps: 12 },
                        { id: 'push_8', name: 'Extensi√≥n Tr√≠ceps Polea', muscle: 'Tr√≠ceps', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 25, defaultReps: 15 },
                        { id: 'push_9', name: 'Flexiones', muscle: 'Pecho', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 0, defaultReps: 20 },
                        { id: 'push_10', name: 'Press Hombros Sentado', muscle: 'Hombro', routine: 'push', img: './assets/push_illustration.png', defaultSets: 3, defaultWeight: 20, defaultReps: 12 },

                        // PULL (Espalda/B√≠ceps) - IMG: ./assets/pull_illustration.png
                        { id: 'pull_1', name: 'Peso Muerto', muscle: 'Espalda', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 100, defaultReps: 5 },
                        { id: 'pull_2', name: 'Dominadas', muscle: 'Espalda', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 0, defaultReps: 8 },
                        { id: 'pull_3', name: 'Jal√≥n al Pecho', muscle: 'Espalda', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 50, defaultReps: 12 },
                        { id: 'pull_4', name: 'Remo con Barra', muscle: 'Espalda', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 60, defaultReps: 10 },
                        { id: 'pull_5', name: 'Remo Gironda', muscle: 'Espalda', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 50, defaultReps: 12 },
                        { id: 'pull_6', name: 'Face Pull', muscle: 'Hombro Posterior', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 20, defaultReps: 15 },
                        { id: 'pull_7', name: 'Curl con Barra', muscle: 'B√≠ceps', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 25, defaultReps: 12 },
                        { id: 'pull_8', name: 'Curl Martillo', muscle: 'B√≠ceps', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 14, defaultReps: 12 },
                        { id: 'pull_9', name: 'Curl Predicador', muscle: 'B√≠ceps', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 20, defaultReps: 12 },
                        { id: 'pull_10', name: 'Shrugs (Trapecio)', muscle: 'Trapecio', routine: 'pull', img: './assets/pull_illustration.png', defaultSets: 3, defaultWeight: 60, defaultReps: 15 },

                        // LEGS (Pierna) - IMG: ./assets/legs_illustration.png
                        { id: 'legs_1', name: 'Sentadilla', muscle: 'Cu√°driceps', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 4, defaultWeight: 80, defaultReps: 8 },
                        { id: 'legs_2', name: 'Prensa 45¬∫', muscle: 'Pierna', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 4, defaultWeight: 150, defaultReps: 12 },
                        { id: 'legs_3', name: 'Peso Muerto Rumano', muscle: 'Isquios', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 80, defaultReps: 10 },
                        { id: 'legs_4', name: 'Zancadas (Lunges)', muscle: 'Pierna', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 20, defaultReps: 12 },
                        { id: 'legs_5', name: 'Extensi√≥n Cu√°driceps', muscle: 'Cu√°driceps', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 40, defaultReps: 15 },
                        { id: 'legs_6', name: 'Curl Femoral Tumbado', muscle: 'Isquios', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 30, defaultReps: 12 },
                        { id: 'legs_7', name: 'Elevaci√≥n de Talones', muscle: 'Gemelo', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 4, defaultWeight: 40, defaultReps: 20 },
                        { id: 'legs_8', name: 'Hip Thrust', muscle: 'Gl√∫teo', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 80, defaultReps: 10 },
                        { id: 'legs_9', name: 'Sentadilla Goblet', muscle: 'Cu√°driceps', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 24, defaultReps: 12 },
                        { id: 'legs_10', name: 'Sentadilla B√∫lgara', muscle: 'Pierna', routine: 'legs', img: './assets/legs_illustration.png', defaultSets: 3, defaultWeight: 16, defaultReps: 10 },
                    ];

                    initialExercises.forEach(ex => {
                        const ref = db.collection('exercises').doc(ex.id);
                        batch.set(ref, ex);
                    });

                    await batch.commit();
                    alert("Base de datos restaurada. Recarga si es necesario.");
                } catch (error) {
                    console.error("Error al restaurar:", error);
                    alert("ERROR: No se pudo escribir en la base de datos.\n\n" + error.message + "\n\nPasos para solucionar:\n1. Ve a Firebase Console > Firestore Database > Reglas (Rules)\n2. Aseg√∫rate de que permiten leer y escribir (read, write) si est√°s autenticado.\n3. Si est√° en 'monitor mode' (allow read, write: if false;), c√°mbialo a 'allow read, write: if request.auth != null;'");
                }
            };



            const currentData = routinesData[activeRoutine] || { name: 'Cargando...', stats: [], exercises: [] };

            return (
                <div className="min-h-screen pb-24 bg-gray-50 font-sans">
                    {/* Notifications Banner */}
                    <div className="fixed top-20 left-4 right-4 z-[55] space-y-2 pointer-events-none">
                        {notifications.map(notif => (
                            <div key={notif.id} className="bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-xl border-l-4 border-primary-500 animate-slide-in pointer-events-auto flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                                        <Icon name={notif.type === 'nudge' ? 'megaphone' : 'bell'} className="w-5 h-5 text-primary-600" />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-gray-900 text-sm">
                                            {notif.type === 'nudge' ? `${notif.fromName} te est√° gritando:` : 'Nueva notificaci√≥n'}
                                        </h4>
                                        <p className="text-gray-600 text-xs">{notif.message}</p>
                                    </div>
                                </div>
                                <button onClick={() => dismissNotification(notif.id)} className="p-2 hover:bg-gray-100 rounded-full">
                                    <Icon name="x" className="w-4 h-4 text-gray-400" />
                                </button>
                            </div>
                        ))}
                    </div>

                    {/* Offline Banner */}
                    {!isOnline && (
                        <div className="bg-yellow-500 text-white p-2 text-center text-xs font-bold sticky top-0 z-[60] shadow-md animate-slide-up">
                            <Icon name="wifi-off" className="inline-block mr-2" />
                            Modo sin conexi√≥n - Guardando localmente...
                        </div>
                    )}
                    {/* Header */}
                    <div className="bg-gradient-to-b from-white to-stone-50 p-6 pb-4 sticky top-0 z-50 border-b border-white/50 backdrop-blur-md">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div onClick={() => setShowProfileModal(true)} className="cursor-pointer hover:opacity-80 transition-opacity">
                                    <h1 className="text-2xl font-black text-gray-900 tracking-tight flex items-center gap-2">
                                        FitnessConDios <Icon name="dumbbell" className="w-6 h-6 text-primary-500 fill-primary-500" />
                                    </h1>
                                    <p className="text-xs text-stone-500 font-medium">Hola, {user.email.split('@')[0]}</p>
                                </div>
                                <div className="shadow-[0_0_15px_rgba(234,179,8,0.15)] rounded-full">
                                    <LevelBadge stats={userStats} onClick={() => setShowBadgesModal(true)} />
                                </div>
                            </div>
                            <div className="flex gap-2">

                                <div className="relative">
                                    {/* Avatar Wrapper with Level Ring */}
                                    <div onClick={() => setShowUserMenu(!showUserMenu)} className="relative cursor-pointer group">
                                        {/* Animated Ring */}
                                        <svg className="absolute -top-1 -left-1 w-12 h-12 text-gold-400 opacity-0 group-hover:opacity-100 transition-opacity duration-500 animate-spin-slow pointer-events-none" viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="48" fill="none" strokeWidth="1.5" stroke="currentColor" strokeDasharray="10 6" strokeLinecap="round" />
                                        </svg>

                                        <div className="w-10 h-10 rounded-full bg-stone-200 overflow-hidden border-2 border-white shadow-md ring-2 ring-transparent group-hover:ring-gold-100 transition-all">
                                            <img src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`} alt="User" />
                                        </div>
                                    </div>

                                    {showUserMenu && (
                                        <div className="absolute right-0 top-12 w-48 bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white py-2 z-[100] animate-scale-in origin-top-right">
                                            <button onClick={() => { setShowProfileModal(true); setShowUserMenu(false); }} className="w-full text-left px-4 py-3 text-sm font-medium text-gray-700 hover:bg-stone-50 flex items-center gap-3">
                                                <Icon name="user" className="w-4 h-4 text-stone-400" /> Perfil
                                            </button>
                                            <button onClick={() => { setShowAdminPanel(true); setShowUserMenu(false); }} className="w-full text-left px-4 py-3 text-sm font-medium text-gray-700 hover:bg-stone-50 flex items-center gap-3">
                                                <Icon name="shield" className="w-4 h-4 text-stone-400" /> Admin
                                            </button>
                                            <button onClick={() => { toggleDarkMode(); setShowUserMenu(false); }} className="w-full text-left px-4 py-3 text-sm font-medium text-gray-700 hover:bg-stone-50 flex items-center gap-3">
                                                <Icon name={darkMode ? "sun" : "moon"} className="w-4 h-4 text-stone-400" /> {darkMode ? 'Modo Claro' : 'Modo Oscuro'}
                                            </button>
                                            <div className="h-px bg-gray-100 my-1 mx-4"></div>
                                            <button onClick={onLogout} className="w-full text-left px-4 py-3 text-sm font-medium text-red-600 hover:bg-red-50 flex items-center gap-3">
                                                <Icon name="log-out" className="w-4 h-4" /> Cerrar Sesi√≥n
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="p-6 space-y-2 animate-fade-in">
                        {activeTab === 'home' && (
                            <React.Fragment>
                                <CalorieTracker user={user} target={userProfile ? userProfile.tdee : 2000} />
                                <RoutineSelector
                                    activeRoutine={activeRoutine}
                                    setActiveRoutine={setActiveRoutine}
                                    customRoutines={customRoutines}
                                    favorites={favoriteRoutines}
                                    onCreateRoutine={() => setShowCreateRoutineModal(true)}
                                />
                                <ProgressChart routineName={currentData.name} dataPoints={currentData.stats} />

                                <div className="mt-8">
                                    <div className="flex justify-between items-end mb-4">
                                        <div className="flex items-center gap-3">
                                            <h3 className="font-bold text-gray-800 text-lg">{currentData.name}</h3>

                                            {/* Routine Actions */}
                                            <button
                                                onClick={() => handleToggleFavorite(activeRoutine)}
                                                className={`p-1.5 rounded-lg transition-colors ${favoriteRoutines.includes(activeRoutine) ? 'bg-yellow-50 text-yellow-500' : 'text-gray-300 hover:bg-gray-100 hover:text-gray-500'}`}
                                            >
                                                <Icon name="star" className={`w-5 h-5 ${favoriteRoutines.includes(activeRoutine) ? 'fill-yellow-500' : ''}`} />
                                            </button>

                                            {!['push', 'pull', 'legs'].includes(activeRoutine) && (
                                                <button
                                                    onClick={() => handleDeleteRoutine(activeRoutine, currentData.name)}
                                                    className="p-1.5 rounded-lg text-gray-300 hover:bg-red-50 hover:text-red-500 transition-colors"
                                                >
                                                    <Icon name="trash-2" className="w-5 h-5" />
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setShowAddModal(true)} className="text-xs bg-primary-50 text-primary-600 px-3 py-1 rounded-lg font-bold hover:bg-primary-100 transition-colors flex items-center gap-1">
                                                <Icon name="plus" className="w-3 h-3" /> Ejercicio
                                            </button>
                                            <span className="text-xs text-gray-400 font-medium self-center">Auto-guardado</span>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {/* Search Filter */}
                                        <div className="relative">
                                            <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                                            <input
                                                type="text"
                                                placeholder="Buscar ejercicio..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-full pl-10 pr-4 py-3 bg-white border border-gray-100 rounded-xl text-sm font-medium focus:ring-2 focus:ring-primary-100 outline-none shadow-sm"
                                            />
                                        </div>

                                        {currentData.exercises.filter(ex => ex.name.toLowerCase().includes(searchTerm.toLowerCase())).length === 0 ? (
                                            <div className="text-center py-10 text-gray-400">
                                                <p>No hay ejercicios en esta rutina.</p>
                                                {exercises.length === 0 && <p className="text-xs mt-2">Dale al bot√≥n "Restaurar DB" arriba a la derecha.</p>}
                                            </div>

                                        ) : (
                                            currentData.exercises
                                                .filter(ex => ex.name.toLowerCase().includes(searchTerm.toLowerCase()))
                                                .map(ex => (
                                                    <ExerciseCard
                                                        key={ex.id}
                                                        exercise={ex}
                                                        logs={logs}
                                                        userProfile={userProfile}
                                                        onUpdateSet={handleUpdateSet}
                                                        onAddSet={handleAddSet}
                                                        onRemoveSet={handleRemoveSet}
                                                        onOpenCalc={(w) => setPlateCalc({ isOpen: true, weight: w })}
                                                        onOpenChart={(id, name) => setChartModal({ isOpen: true, exerciseId: id, name })}
                                                        onEdit={handleEditExercise}
                                                    />
                                                ))
                                        )}
                                    </div>
                                </div>
                            </React.Fragment>
                        )}

                        {activeTab === 'social' && (
                            <SocialPanel user={user} userProfile={userProfile} />
                        )}

                        {/* Calendar Tab */}
                        {activeTab === 'calendar' && (
                            <CalendarView user={user} />
                        )}
                    </div>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-white/50 flex justify-around items-center p-4 pb-8 z-50 shadow-[0_-5px_30px_rgba(0,0,0,0.03)]">
                        <button
                            onClick={() => setActiveTab('home')}
                            className={`relative flex flex-col items-center gap-1 transition-all duration-300 w-16 group ${activeTab === 'home' ? 'text-primary-600 -translate-y-2' : 'text-stone-400 hover:text-stone-600'}`}
                        >
                            <div className={`absolute -top-4 w-8 h-1 bg-gradient-to-r from-primary-500 to-primary-600 rounded-b-full shadow-lg shadow-primary-500/30 transition-all duration-300 ${activeTab === 'home' ? 'opacity-100' : 'opacity-0 translate-y-2'}`}></div>
                            <Icon name="home" className={`w-7 h-7 transition-all duration-300 ${activeTab === 'home' ? 'fill-primary-50 stroke-primary-600' : ''}`} />
                            <span className={`text-[10px] font-bold transition-opacity duration-300 ${activeTab === 'home' ? 'opacity-100' : 'opacity-0 hidden'}`}>Inicio</span>
                        </button>

                        <button
                            onClick={() => setActiveTab('social')}
                            className={`relative flex flex-col items-center gap-1 transition-all duration-300 w-16 group ${activeTab === 'social' ? 'text-primary-600 -translate-y-2' : 'text-stone-400 hover:text-stone-600'}`}
                        >
                            <div className={`absolute -top-4 w-8 h-1 bg-gradient-to-r from-primary-500 to-primary-600 rounded-b-full shadow-lg shadow-primary-500/30 transition-all duration-300 ${activeTab === 'social' ? 'opacity-100' : 'opacity-0 translate-y-2'}`}></div>
                            <div className="relative">
                                <Icon name="users" className={`w-7 h-7 transition-all duration-300 ${activeTab === 'social' ? 'fill-primary-50 stroke-primary-600' : ''}`} />
                                {notifications.length > 0 && <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>}
                            </div>
                            <span className={`text-[10px] font-bold transition-opacity duration-300 ${activeTab === 'social' ? 'opacity-100' : 'opacity-0 hidden'}`}>Social</span>
                        </button>

                        <div className="relative -top-10">
                            <button
                                onClick={() => setShowAddModal(true)}
                                className="group w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full text-white shadow-xl shadow-primary-500/40 flex items-center justify-center transform transition-all duration-300 hover:scale-110 active:scale-95 border-4 border-stone-50"
                            >
                                <div className="absolute inset-0 rounded-full border border-white/20"></div>
                                <Icon name="plus" className="w-8 h-8 stroke-[3px] transition-transform duration-300 group-hover:rotate-90" />
                            </button>
                        </div>

                        <button
                            onClick={() => setActiveTab('calendar')}
                            className={`relative flex flex-col items-center gap-1 transition-all duration-300 w-16 group ${activeTab === 'calendar' ? 'text-primary-600 -translate-y-2' : 'text-stone-400 hover:text-stone-600'}`}
                        >
                            <div className={`absolute -top-4 w-8 h-1 bg-gradient-to-r from-primary-500 to-primary-600 rounded-b-full shadow-lg shadow-primary-500/30 transition-all duration-300 ${activeTab === 'calendar' ? 'opacity-100' : 'opacity-0 translate-y-2'}`}></div>
                            <Icon name="calendar-days" className={`w-7 h-7 transition-all duration-300 ${activeTab === 'calendar' ? 'fill-primary-50 stroke-primary-600' : ''}`} />
                            <span className={`text-[10px] font-bold transition-opacity duration-300 ${activeTab === 'calendar' ? 'opacity-100' : 'opacity-0 hidden'}`}>Diario</span>
                        </button>
                    </div>

                    <RestTimer
                        initialTime={timer.time}
                        isActive={timer.isActive}
                        onComplete={() => {
                            // alert("¬°Descanso terminado!"); // Optional: keep silent visually
                            setTimer({ ...timer, isActive: false });
                        }}
                        onCancel={() => setTimer({ ...timer, isActive: false })}
                    />

                    {plateCalc.isOpen && (
                        <PlateCalculatorModal
                            initialWeight={plateCalc.weight}
                            onClose={() => setPlateCalc({ ...plateCalc, isOpen: false })}
                        />
                    )}

                    {chartModal.isOpen && (
                        <ExerciseChartModal
                            exerciseId={chartModal.exerciseId}
                            exerciseName={chartModal.name}
                            logs={logs}
                            onClose={() => setChartModal({ ...chartModal, isOpen: false })}
                        />
                    )}

                    {showAddModal && <AddExerciseModal user={user} onClose={() => setShowAddModal(false)} onSave={handleAddExercise} />}
                    {showProfileModal && (
                        <UserProfileModal
                            user={user}
                            initialData={userProfile}
                            onClose={() => setShowProfileModal(false)}
                            onSave={handleSaveProfile}
                        />
                    )}

                    {pointsAnimation.show && (
                        <PointsPopup
                            amount={pointsAnimation.amount}
                            reason={pointsAnimation.reason}
                            onComplete={() => setPointsAnimation({ show: false, amount: 0, reason: '' })}
                        />
                    )}

                    {showBadgesModal && (
                        <BadgesModal stats={userStats} onClose={() => setShowBadgesModal(false)} />
                    )}

                    {showAdminPanel && (
                        <AdminPanel user={user} onClose={() => setShowAdminPanel(false)} />
                    )}

                    {showCreateRoutineModal && (
                        <CreateRoutineModal
                            user={user}
                            onClose={() => setShowCreateRoutineModal(false)}
                            onSave={() => setShowCreateRoutineModal(false)}
                        />
                    )}

                    {editExercise && (
                        <EditExerciseModal
                            exercise={editExercise}
                            onClose={() => setEditExercise(null)}
                            onSave={handleUpdateExercise}
                            onDelete={handleDeleteExercise}
                        />
                    )}
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught error:", error, errorInfo);
                this.setState({ errorInfo });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-6 bg-red-50">
                            <div className="bg-white p-8 rounded-3xl shadow-xl max-w-lg w-full">
                                <h2 className="text-2xl font-black text-red-600 mb-4 flex items-center gap-2">
                                    <Icon name="alert-triangle" /> Algo sali√≥ mal
                                </h2>
                                <p className="text-gray-600 mb-4 font-medium">La aplicaci√≥n ha encontrado un error inesperado.</p>
                                <div className="bg-gray-100 p-4 rounded-xl text-xs font-mono overflow-auto max-h-48 mb-6 border border-gray-200">
                                    {this.state.error && this.state.error.toString()}
                                    <br />
                                    {this.state.errorInfo && this.state.errorInfo.componentStack}
                                </div>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="w-full py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-500/30 hover:bg-red-700 transition-colors"
                                >
                                    Recargar P√°gina
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- ROOT COMPONENT (Auth Handler) ---

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);



            React.useEffect(() => {
                // Listen to Firebase Auth state
                const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => {
                firebase.auth().signOut();
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-white">
                        <Icon name="loader-2" className="w-8 h-8 text-primary-500 animate-spin" />
                    </div>
                );
            }

            if (!user) {
                return <Login />;
            }

            return (
                <ErrorBoundary>
                    <Dashboard user={user} onLogout={handleLogout} />
                </ErrorBoundary>
            );
        };

        // Verification Screen Component
        const VerificationScreen = ({ user }) => {
            const [pin, setPin] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleVerify = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    // Client-side Secure Hash Check
                    const msgBuffer = new TextEncoder().encode(pin);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                    const validHash = "5898d25458140409c99661448880a13854eb05f0134f71a7d9715ec34b797f56";

                    if (hashHex === validHash) {
                        // Success - Unlock User
                        await db.collection('pending_users').doc(user.uid).delete();

                        // Create Public Profile entry for Social Search
                        const safeEmail = user.email.replace(/\./g, '_');
                        await db.collection('users_public').doc(safeEmail).set({
                            uid: user.uid,
                            email: user.email,
                            name: user.email.split('@')[0], // Default name
                            level: 0,
                            photo: `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`
                        });

                        // Reload to enter Dashboard using window.location ensuring clean state
                        window.location.reload();
                    } else {
                        throw new Error('PIN Incorrecto');
                    }

                } catch (err) {
                    console.error("Verification Error:", err);
                    setError(err.message || 'C√≥digo incorrecto');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-gray-50">
                    <div className="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl animate-fade-in text-center">
                        <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon name="lock" className="w-8 h-8 text-yellow-600" />
                        </div>
                        <h2 className="text-2xl font-black text-gray-900 mb-2">Verificaci√≥n Necesaria</h2>
                        <p className="text-gray-500 mb-6 text-sm">Tu cuenta est√° pendiente. Introduce el c√≥digo de acceso o espera a que un administrador te apruebe.</p>

                        {error && (
                            <div className="mb-4 p-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold flex items-center justify-center gap-2">
                                <Icon name="alert-circle" className="w-4 h-4" /> {error}
                            </div>
                        )}

                        <form onSubmit={handleVerify} className="space-y-4">
                            <input
                                type="password"
                                value={pin}
                                onChange={e => setPin(e.target.value)}
                                placeholder="C√≥digo de Acceso"
                                className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-center text-xl font-black tracking-widest focus:outline-none focus:ring-2 focus:ring-primary-500"
                                autoFocus
                            />
                            <button
                                type="submit"
                                disabled={loading || !pin}
                                className="w-full bg-primary-600 text-white rounded-xl py-3 font-bold shadow-lg shadow-primary-500/30 hover:bg-primary-700 disabled:opacity-50 transition-all flex items-center justify-center gap-2"
                            >
                                {loading ? <Icon name="loader-2" className="w-5 h-5 animate-spin" /> : 'Validar Acceso'}
                            </button>
                        </form>

                        <button onClick={() => firebase.auth().signOut()} className="mt-6 text-xs font-bold text-gray-400 hover:text-gray-600">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        // ServiceWorker registered
                    })
                    .catch((error) => {
                        // ServiceWorker failed
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show custom install banner (optional - can be triggered by button)
            // PWA install available
        });

        // Function to trigger install (can be called from a button)
        window.installPWA = () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        // User accepted install
                    }
                    deferredPrompt = null;
                });
            }
        };
    </script>
</body>

</html>